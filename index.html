<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Lumina: Omni-Tool Edition - Rastreador Lunar Táctico">
    <title>Lumina: Edición Omni-Tool</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lumina: {
                            bg: '#050505',
                            cyber: '#38bdf8',
                            plasma: '#d946ef',
                            gold: '#fbbf24',
                            glass: 'rgba(20, 20, 30, 0.7)',
                            glassBorder: 'rgba(255, 255, 255, 0.1)',
                            alert: '#ef4444',
                        },
                        fontFamily: {
                            tech: ['Orbitron', 'sans-serif'],
                            mono: ['Rajdhani', 'monospace'],
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 12s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Global Reset & Base */
        :root {
            --color-bg: #050505;
            --color-cyber: #38bdf8;
            --color-plasma: #d946ef;
        }

        body {
            background-color: var(--color-bg);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: var(--lumina-glass, rgba(20, 20, 30, 0.7));
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.4), transparent);
            opacity: 0.5;
        }

        .glass-panel:hover {
            border-color: rgba(56, 189, 248, 0.3);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.15);
        }

        /* Scanline Background */
        .scanline-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.3) 50%, rgba(0, 0, 0, 0.3));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: -1;
            opacity: 0.6;
        }

        /* Target Lock Styles */
        .target-locked {
            border-color: var(--color-plasma) !important;
            box-shadow: 0 0 30px var(--color-plasma) !important;
        }

        .text-locked {
            color: var(--color-plasma) !important;
            text-shadow: 0 0 10px var(--color-plasma);
        }

        /* Performance Optimization */
        .will-change-transform {
            will-change: transform;
        }

        /* Scrollbar prevention */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* AR HUD Overlay */
        #ar-hud {
            pointer-events: none;
        }

        .hud-line {
            background: rgba(255, 255, 255, 0.3);
            height: 1px;
            width: 100%;
        }
    </style>
</head>

<body class="relative">

    <!-- AR Background Video -->
    <video id="ar-video"
        class="fixed top-0 left-0 w-full h-full object-cover -z-20 opacity-0 transition-opacity duration-1000"
        playsinline muted autoplay></video>

    <!-- AR HUD Overlay (Hidden by default) -->
    <div id="ar-hud"
        class="fixed inset-0 z-0 opacity-0 transition-opacity duration-300 flex flex-col justify-between p-4">
        <!-- Top HUD -->
        <div class="flex justify-between items-start">
            <div class="glass-panel px-3 py-1 border-l-4 border-lumina-cyber">
                <span class="text-[9px] text-gray-400 font-tech uppercase block">Rumbo</span>
                <span id="hud-heading" class="text-xl font-tech text-white">000°</span>
            </div>

            <!-- Artificial Horizon Line (Top Center visual aid) -->
            <div class="flex-1 mx-4 mt-4 border-t border-white/20 flex justify-center relative">
                <div class="absolute -top-1.5 w-[1px] h-3 bg-lumina-cyber"></div>
                <span class="absolute -top-5 text-[9px] text-lumina-cyber font-mono bg-black/50 px-1">NIVEL</span>
            </div>

            <div class="glass-panel px-3 py-1 border-r-4 border-lumina-plasma text-right">
                <span class="text-[9px] text-gray-400 font-tech uppercase block">Objetivo</span>
                <span id="hud-target" class="text-xl font-tech text-lumina-plasma">---°</span>
            </div>
        </div>

        <!-- Center Reticle (Dynamic) -->
        <div
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 flex items-center justify-center opacity-80">
            <!-- Outer Ring -->
            <div id="hud-reticle-ring"
                class="absolute w-full h-full rounded-full border border-dashed border-white/30 animate-[spin_10s_linear_infinite]">
            </div>
            <!-- Inner Bracket -->
            <div id="hud-reticle-bracket"
                class="absolute w-32 h-32 border-2 border-white/50 border-t-0 border-b-0 rounded-lg transition-colors duration-300">
            </div>
            <!-- Center Crosshair -->
            <div class="w-4 h-4 relative">
                <div class="absolute top-1/2 left-0 w-full h-[1px] bg-white"></div>
                <div class="absolute top-0 left-1/2 h-full w-[1px] bg-white"></div>
            </div>
        </div>

        <!-- Bottom HUD -->
        <div class="flex justify-between items-end">
            <div class="glass-panel px-3 py-1">
                <span class="text-[9px] text-gray-400 font-tech uppercase block">Alt Luna</span>
                <span id="hud-alt" class="text-lg font-mono text-white">--°</span>
            </div>
            <div class="glass-panel px-3 py-1">
                <span class="text-[9px] text-gray-400 font-tech uppercase block">Distancia</span>
                <span id="hud-dist" class="text-lg font-mono text-white">-- km</span>
            </div>
        </div>
    </div>

    <!-- Background Effects -->
    <div class="scanline-bg"></div>

    <!-- Main Container -->
    <main class="min-h-screen w-full flex flex-col p-4 md:p-6 lg:p-8 pb-32 relative z-10">

        <!-- Header -->
        <header
            class="flex justify-between items-center mb-6 border-b border-lumina-cyber/20 pb-4 backdrop-blur-sm sticky top-0 z-30 pt-2">
            <div class="flex items-center gap-3">
                <i class="ph ph-planet text-3xl text-lumina-cyber animate-pulse-fast"></i>
                <div class="flex flex-col">
                    <h1
                        class="font-tech text-xl md:text-2xl text-lumina-cyber tracking-widest uppercase font-bold text-shadow-glow">
                        Lumina</h1>
                    <span class="text-[10px] text-gray-400 tracking-[0.3em] font-tech uppercase">Omni-Tool
                        Edition</span>
                </div>
            </div>
            <button id="paywall-btn-top"
                class="flex items-center gap-2 bg-lumina-glass border border-lumina-gold/40 px-3 py-1.5 rounded hover:bg-lumina-gold/10 transition-colors group">
                <i
                    class="ph ph-crown-simple text-lumina-gold group-hover:drop-shadow-[0_0_5px_rgba(251,191,36,0.8)]"></i>
                <span class="text-xs font-bold text-lumina-gold font-tech hidden sm:inline">PREMIUM</span>
            </button>
        </header>

        <!-- Dynamic Grid Layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6 w-full max-w-7xl mx-auto">

            <!-- 1. COMPASS & AR MODULE -->
            <section class="col-span-1 md:col-span-1 lg:col-span-4 flex flex-col gap-4">
                <div class="glass-panel p-6 flex flex-col items-center justify-center relative min-h-[350px]">
                    <div class="absolute top-3 left-3 flex items-center gap-2">
                        <div class="w-1.5 h-1.5 bg-lumina-cyber rounded-full animate-pulse"></div>
                        <span class="text-[10px] text-lumina-cyber/70 font-tech tracking-wider">BRÚJULA TÁCTICA</span>
                    </div>

                    <!-- Compass Visual -->
                    <div class="relative w-64 h-64 md:w-72 md:h-72 flex items-center justify-center my-4">

                        <!-- Line of Sight Indicator (Fixed Heading) -->
                        <div class="absolute -top-4 z-20 flex flex-col items-center">
                            <div
                                class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[10px] border-b-lumina-cyber drop-shadow-[0_0_5px_rgba(56,189,248,0.8)]">
                            </div>
                            <span
                                class="text-[9px] text-lumina-cyber font-tech uppercase tracking-widest mt-1">MIRA</span>
                        </div>

                        <!-- Rotating Compass Ring (North Oriented) -->
                        <div id="compass-ring"
                            class="absolute inset-0 border-2 border-lumina-cyber/20 rounded-full flex items-center justify-center transition-transform duration-100 ease-linear will-change-transform shadow-[0_0_15px_rgba(56,189,248,0.1)]">
                            <!-- Ticks & Labels -->
                            <div class="absolute top-1 w-0.5 h-4 bg-lumina-cyber shadow-[0_0_5px_rgba(56,189,248,1)]">
                            </div>
                            <span class="absolute top-6 text-lumina-cyber font-tech font-bold text-sm">N</span>

                            <div class="absolute bottom-1 w-0.5 h-3 bg-gray-600"></div>
                            <span class="absolute bottom-6 text-gray-500 font-tech text-xs">S</span>

                            <div class="absolute left-1 w-3 h-0.5 bg-gray-600"></div>
                            <span class="absolute left-6 text-gray-500 font-tech text-xs">O</span>

                            <div class="absolute right-1 w-3 h-0.5 bg-gray-600"></div>
                            <span class="absolute right-6 text-gray-500 font-tech text-xs">E</span>

                            <!-- Moon Pointer (Absolute Position relative to North) -->
                            <div id="moon-pointer"
                                class="absolute top-0 bottom-0 w-0.5 bg-transparent origin-center transition-transform duration-300 will-change-transform z-10">
                                <!-- The Arrow/Needle -->
                                <div class="absolute top-4 left-1/2 -translate-x-1/2 flex flex-col items-center">
                                    <div
                                        class="w-6 h-6 rounded-full border-2 border-lumina-plasma bg-black/80 flex items-center justify-center shadow-[0_0_15px_#d946ef]">
                                        <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                                    </div>
                                    <!-- Floating Label -->
                                    <div id="moon-float-label"
                                        class="mt-1 px-2 py-0.5 bg-lumina-plasma/20 border border-lumina-plasma/50 rounded text-[9px] text-lumina-plasma font-tech whitespace-nowrap shadow-lg backdrop-blur-md">
                                        OBJETIVO
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fixed HUD Reticle -->
                        <div id="reticle"
                            class="w-24 h-24 border border-white/10 rounded-full flex items-center justify-center relative transition-all duration-300 pointer-events-none">
                            <div class="absolute w-full h-[1px] bg-white/10"></div>
                            <div class="absolute h-full w-[1px] bg-white/10"></div>
                            <div class="w-1 h-1 bg-lumina-cyber/50 rounded-full"></div>
                        </div>
                    </div>

                    <!-- Digital Readout -->
                    <div class="grid grid-cols-2 gap-x-8 gap-y-2 w-full text-center mt-2 max-w-xs mx-auto">
                        <div class="border-r border-gray-700 pr-4">
                            <span class="block text-[9px] text-gray-500 uppercase tracking-widest">Rumbo Actual</span>
                            <div class="flex items-baseline justify-center gap-1">
                                <span id="heading-val" class="font-tech text-2xl text-white">000°</span>
                                <span id="heading-cardinal" class="font-mono text-xs text-lumina-cyber">--</span>
                            </div>
                        </div>
                        <div class="pl-4">
                            <span class="block text-[9px] text-gray-500 uppercase tracking-widest">Azimut
                                Objetivo</span>
                            <div class="flex items-baseline justify-center gap-1">
                                <span id="azimuth-val" class="font-tech text-2xl text-lumina-plasma">---°</span>
                                <span id="azimuth-cardinal" class="font-mono text-xs text-lumina-plasma">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="w-full text-center mt-3">
                        <span id="lock-status"
                            class="font-tech text-xs text-gray-400 block tracking-[0.2em] border-t border-gray-800 pt-2 mt-2">ESCANEANDO...</span>
                        <p id="target-feedback" class="text-[10px] text-lumina-cyber mt-1 h-4 font-mono"></p>
                    </div>

                    <!-- AR Toggle -->
                    <button id="camera-btn"
                        class="mt-4 px-6 py-2 bg-lumina-cyber/10 border border-lumina-cyber/50 text-lumina-cyber font-tech text-xs uppercase tracking-widest hover:bg-lumina-cyber/20 transition-colors w-full flex items-center justify-center gap-2 rounded-sm group">
                        <i class="ph ph-camera text-lg group-hover:scale-110 transition-transform"></i> <span
                            id="cam-btn-text">Activar HUD Táctico</span>
                    </button>
                    <p id="sensor-msg" class="text-[9px] text-red-500 mt-2 text-center h-3"></p>
                </div>
            </section>

            <!-- 2. DATA CENTER -->
            <section class="col-span-1 md:col-span-1 lg:col-span-8 flex flex-col gap-6">

                <!-- Visibility Verdict Panel -->
                <div class="glass-panel p-4 flex items-center justify-between bg-gradient-to-r from-lumina-glass to-transparent border-l-4 border-l-gray-600 transition-colors duration-500"
                    id="verdict-panel">
                    <div>
                        <h3 class="text-[10px] text-gray-400 font-tech uppercase tracking-widest mb-1">Estado de
                            Observación</h3>
                        <div id="visibility-verdict" class="text-xl md:text-2xl font-tech text-white">CALCULANDO...
                        </div>
                    </div>
                    <div class="text-right">
                        <i id="verdict-icon" class="ph ph-circle-notch animate-spin text-4xl text-gray-500"></i>
                    </div>
                </div>

                <!-- Telemetry Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Phase -->
                    <div
                        class="glass-panel p-4 flex flex-col relative group overflow-hidden hover:border-lumina-cyber/40 transition-colors">
                        <span
                            class="text-[9px] text-lumina-cyber uppercase tracking-wider mb-2 border-l-2 border-lumina-cyber pl-2">Fase
                            Lunar</span>
                        <span id="phase-name" class="font-tech text-lg text-white mb-1">---</span>
                        <span id="illum-percent" class="font-mono text-sm text-gray-400">Ilum: --%</span>
                    </div>

                    <!-- Distance -->
                    <div
                        class="glass-panel p-4 flex flex-col relative group overflow-hidden hover:border-lumina-cyber/40 transition-colors">
                        <span
                            class="text-[9px] text-lumina-cyber uppercase tracking-wider mb-2 border-l-2 border-lumina-cyber pl-2">Distancia</span>
                        <span id="distance-val" class="font-tech text-lg text-white mb-1">--- km</span>
                        <span class="font-mono text-sm text-gray-400">Tiempo Real</span>
                    </div>

                    <!-- Altitude -->
                    <div
                        class="glass-panel p-4 flex flex-col relative group overflow-hidden hover:border-lumina-cyber/40 transition-colors">
                        <span
                            class="text-[9px] text-lumina-cyber uppercase tracking-wider mb-2 border-l-2 border-lumina-cyber pl-2">Altitud</span>
                        <span id="altitude-val" class="font-tech text-lg text-white mb-1">---°</span>
                        <span class="font-mono text-sm text-gray-400">Horizonte Rel.</span>
                    </div>

                    <!-- Meridian -->
                    <div
                        class="glass-panel p-4 flex flex-col relative group overflow-hidden hover:border-lumina-cyber/40 transition-colors">
                        <span
                            class="text-[9px] text-lumina-gold uppercase tracking-wider mb-2 border-l-2 border-lumina-gold pl-2">Próximo
                            Evento</span>
                        <span id="event-type" class="text-[9px] text-gray-500 mb-0.5">---</span>
                        <span id="zenith-val" class="font-tech text-lg text-lumina-gold mb-1">--:--</span>
                    </div>
                </div>

                <!-- Trajectory Graph -->
                <div class="glass-panel w-full p-4 flex flex-col flex-1 min-h-[250px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-[10px] text-gray-400 font-tech uppercase tracking-widest"><i
                                class="ph ph-chart-line-up mr-2"></i>Trayectoria Orbital</h3>
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 bg-lumina-cyber rounded-full animate-pulse"></span>
                            <span class="text-[9px] text-lumina-cyber tracking-wider">EN VIVO</span>
                        </div>
                    </div>
                    <div
                        class="relative w-full h-full flex-1 rounded border border-white/5 bg-black/40 overflow-hidden">
                        <canvas id="trajectory-canvas" class="w-full h-full block cursor-crosshair"></canvas>
                        <!-- Dynamic overlay info -->
                        <div class="absolute bottom-2 left-2 text-[9px] font-mono text-gray-500">
                            Eje X: Tiempo / Eje Y: Altitud
                        </div>
                    </div>
                </div>

            </section>
        </div>

        <!-- Extra Tools (Locked) -->
        <section class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-7xl mx-auto">
            <div
                class="paywall-lock glass-panel p-6 flex flex-col items-center justify-center opacity-60 hover:opacity-100 transition-opacity cursor-pointer border-dashed border-gray-600 hover:border-lumina-gold group">
                <i
                    class="ph ph-map-trifold text-3xl text-lumina-gold mb-2 group-hover:scale-110 transition-transform"></i>
                <h4 class="font-tech text-xs text-gray-300">Mapas Contaminación</h4>
                <i class="ph ph-lock-key text-lumina-gold mt-2"></i>
            </div>
            <div
                class="paywall-lock glass-panel p-6 flex flex-col items-center justify-center opacity-60 hover:opacity-100 transition-opacity cursor-pointer border-dashed border-gray-600 hover:border-lumina-gold group">
                <i
                    class="ph ph-camera-rotate text-3xl text-lumina-gold mb-2 group-hover:scale-110 transition-transform"></i>
                <h4 class="font-tech text-xs text-gray-300">Planificador Fotos</h4>
                <i class="ph ph-lock-key text-lumina-gold mt-2"></i>
            </div>
            <div
                class="paywall-lock glass-panel p-6 flex flex-col items-center justify-center opacity-60 hover:opacity-100 transition-opacity cursor-pointer border-dashed border-gray-600 hover:border-lumina-gold group">
                <i
                    class="ph ph-mountains text-3xl text-lumina-gold mb-2 group-hover:scale-110 transition-transform"></i>
                <h4 class="font-tech text-xs text-gray-300">Terreno 3D</h4>
                <i class="ph ph-lock-key text-lumina-gold mt-2"></i>
            </div>
            <div
                class="paywall-lock glass-panel p-6 flex flex-col items-center justify-center opacity-60 hover:opacity-100 transition-opacity cursor-pointer border-dashed border-gray-600 hover:border-lumina-gold group">
                <i
                    class="ph ph-star-four text-3xl text-lumina-gold mb-2 group-hover:scale-110 transition-transform"></i>
                <h4 class="font-tech text-xs text-gray-300">Constelaciones</h4>
                <i class="ph ph-lock-key text-lumina-gold mt-2"></i>
            </div>
        </section>

    </main>

    <!-- Navigation Dock -->
    <nav class="fixed bottom-0 left-0 w-full z-40 px-4 pb-4 pt-2">
        <div
            class="glass-panel mx-auto max-w-lg h-16 flex items-center justify-around px-2 shadow-[0_-5px_20px_rgba(0,0,0,0.5)] bg-black/80">
            <button class="flex flex-col items-center gap-1 text-lumina-cyber p-2">
                <i class="ph ph-crosshair text-xl"></i>
                <span class="text-[9px] font-tech uppercase">Rastreo</span>
            </button>
            <button class="flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors p-2">
                <i class="ph ph-chart-bar text-xl"></i>
                <span class="text-[9px] font-tech uppercase">Datos</span>
            </button>
            <div
                class="w-16 h-16 bg-lumina-cyber rounded-full -mt-10 flex items-center justify-center shadow-[0_0_20px_rgba(56,189,248,0.5)] border-4 border-[#050505] hover:scale-105 transition-transform cursor-pointer">
                <i class="ph ph-moon-stars text-2xl text-black"></i>
            </div>
            <button
                class="paywall-lock flex flex-col items-center gap-1 text-lumina-gold/70 hover:text-lumina-gold transition-colors p-2">
                <i class="ph ph-images text-xl"></i>
                <span class="text-[9px] font-tech uppercase relative">Galería <i
                        class="ph ph-lock-key text-[8px] absolute -top-1 -right-2"></i></span>
            </button>
            <button class="flex flex-col items-center gap-1 text-gray-500 hover:text-white transition-colors p-2">
                <i class="ph ph-gear text-xl"></i>
                <span class="text-[9px] font-tech uppercase">Sistema</span>
            </button>
        </div>
    </nav>

    <!-- Paywall Modal -->
    <div id="paywall-modal"
        class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
        <div
            class="glass-panel w-full sm:w-96 m-4 p-8 flex flex-col items-center text-center transform translate-y-10 transition-transform duration-300 border-lumina-gold/50 shadow-[0_0_40px_rgba(251,191,36,0.15)]">
            <i class="ph ph-crown text-5xl text-lumina-gold mb-4 animate-[bounce_2s_infinite]"></i>
            <h2 class="font-tech text-2xl text-white mb-2">DESBLOQUEAR OMNI-TOOL</h2>
            <div class="w-16 h-1 bg-lumina-gold/50 mb-4 rounded-full"></div>
            <p class="text-sm text-gray-300 mb-6 leading-relaxed">
                Acceso a funciones militares: <span class="text-lumina-gold">Mapas de Luz</span>, <span
                    class="text-lumina-gold">Terreno 3D</span>, y el <span class="text-lumina-gold">Planificador de
                    Astrofotografía</span>.
            </p>
            <button id="sim-pay-btn"
                class="w-full py-4 bg-lumina-gold text-black font-bold font-tech text-lg uppercase tracking-widest hover:bg-yellow-400 transition-colors rounded-sm shadow-[0_0_20px_rgba(251,191,36,0.4)]">
                INICIALIZAR ($4.99)
            </button>
            <button id="close-paywall"
                class="mt-4 text-xs text-gray-500 hover:text-white underline font-mono">Cancelar</button>
        </div>
    </div>

    <!-- Permission Modal (iOS) -->
    <div id="perm-modal"
        class="fixed inset-0 z-[60] flex items-center justify-center bg-black transition-opacity duration-300 hidden">
        <div class="glass-panel max-w-xs p-6 text-center border-lumina-cyber/50">
            <i class="ph ph-compass text-4xl text-lumina-cyber mb-4"></i>
            <h3 class="font-tech text-lg text-white mb-2">CALIBRACIÓN DE SENSOR</h3>
            <p class="text-xs text-gray-400 mb-6 font-mono">Lumina requiere acceso al giroscopio para la alineación
                táctica.</p>
            <button id="grant-perm-btn"
                class="px-8 py-3 bg-lumina-cyber text-black font-bold font-tech uppercase tracking-widest rounded hover:bg-cyan-400 shadow-[0_0_15px_rgba(56,189,248,0.4)]">
                CONCEDER ACCESO
            </button>
        </div>
    </div>

    <!-- Core Logic -->
    <script>
        // --- UTILS ---
        const $ = (id) => document.getElementById(id);
        const $$ = (sel) => document.querySelectorAll(sel);
        const formatDeg = (d) => `${Math.round(d).toString().padStart(3, '0')}°`;
        const formatTime = (d) => d ? d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '--:--';
        const formatDist = (d) => Math.round(d).toLocaleString('es-ES'); // Spanish thousands separator point

        const getCardinal = (deg) => {
            const norm = ((deg % 360) + 360) % 360;
            const val = Math.floor((norm / 22.5) + 0.5);
            // Spanish cardinals: N, NNE, NE, ENE, E, ESE, SE, SSE, S, SSO, SO (SW), OSO, O (W), ONO, NO (NW), NNO
            const arr = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSO", "SO", "OSO", "O", "ONO", "NO", "NNO"];
            return arr[val % 16];
        };

        // --- APP STATE ---
        const State = {
            pos: { lat: 0, lon: 0 },
            heading: 0,
            targetHeading: 0,
            moonAz: 0,
            moonAlt: 0,
            dist: 0,
            isPro: false,
            sensorsActive: false,
            lastTick: 0,
            animationId: null
        };

        // --- MAIN APP ---
        const App = {
            init() {
                this.bindUI();
                this.checkPlatform();
                this.startTelemetry();
                this.requestLocation();

                requestAnimationFrame((t) => this.loop(t));
                console.log("Lumina Omni-Tool inicializado v3.0 ES.");
            },

            bindUI() {
                $('camera-btn').addEventListener('click', () => this.toggleCamera());

                $$('.paywall-lock, #paywall-btn-top').forEach(el => {
                    el.addEventListener('click', () => this.showPaywall());
                });
                $('close-paywall').addEventListener('click', () => this.hidePaywall());
                $('sim-pay-btn').addEventListener('click', () => this.processUpgrade());
                $('grant-perm-btn').addEventListener('click', () => this.requestSensors());
                window.addEventListener('resize', () => this.drawTrajectory());
            },

            checkPlatform() {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    $('sensor-msg').innerText = "REQUIERE CALIBRACIÓN";
                } else {
                    this.startSensorListeners();
                }
            },

            requestSensors() {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(resp => {
                            if (resp === 'granted') {
                                $('perm-modal').classList.add('hidden');
                                this.startSensorListeners();
                            }
                        })
                        .catch(console.error);
                } else {
                    $('perm-modal').classList.add('hidden');
                    this.startSensorListeners();
                }
            },

            startSensorListeners() {
                const handleOr = (e) => {
                    let alpha = e.alpha;
                    if (e.webkitCompassHeading) {
                        alpha = e.webkitCompassHeading;
                    } else {
                        // Android default approx
                        alpha = 360 - alpha;
                    }

                    if (alpha === null || isNaN(alpha)) return;

                    // Shortest Path Interpolation
                    let currentMod = ((State.heading % 360) + 360) % 360;
                    let delta = alpha - currentMod;

                    if (delta > 180) delta -= 360;
                    if (delta < -180) delta += 360;

                    State.heading += delta;
                    State.sensorsActive = true;
                    $('sensor-msg').innerText = "";
                };

                if ('ondeviceorientationabsolute' in window) {
                    window.addEventListener("deviceorientationabsolute", handleOr, true);
                } else {
                    window.addEventListener("deviceorientation", handleOr, true);
                }
            },

            requestLocation() {
                if ("geolocation" in navigator) {
                    navigator.geolocation.watchPosition(
                        (p) => {
                            State.pos.lat = p.coords.latitude;
                            State.pos.lon = p.coords.longitude;
                            this.updateTelemetry();
                        },
                        (err) => {
                            console.warn("GPS Fail", err);
                            $('visibility-verdict').innerText = "GPS OFFLINE";
                            $('visibility-verdict').className = "text-xl md:text-2xl font-tech text-red-500";
                        },
                        { enableHighAccuracy: true }
                    );
                }
            },

            toggleCamera() {
                const vid = $('ar-video');
                const hud = $('ar-hud');
                const btnText = $('cam-btn-text');

                if (vid.srcObject) {
                    // Stop
                    vid.srcObject.getTracks().forEach(t => t.stop());
                    vid.srcObject = null;
                    vid.style.opacity = '0';
                    hud.style.opacity = '0'; // Hide HUD
                    btnText.innerText = "Activar HUD Táctico";
                    $('camera-btn').classList.remove('bg-red-500/20', 'border-red-500/50', 'text-red-500');
                    $('camera-btn').classList.add('bg-lumina-cyber/10', 'border-lumina-cyber/50', 'text-lumina-cyber');
                } else {
                    // Start
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                        .then(stream => {
                            vid.srcObject = stream;
                            vid.style.opacity = '1';
                            hud.style.opacity = '1'; // Show HUD
                            btnText.innerText = "Desactivar HUD";
                            $('camera-btn').classList.remove('bg-lumina-cyber/10', 'border-lumina-cyber/50', 'text-lumina-cyber');
                            $('camera-btn').classList.add('bg-red-500/20', 'border-red-500/50', 'text-red-500');

                            if (!State.sensorsActive && typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                                $('perm-modal').classList.remove('hidden');
                            }
                        })
                        .catch(err => {
                            alert("Acceso a cámara denegado. Revise permisos o HTTPS.");
                        });
                }
            },

            // --- LOGIC FRAMEWORK ---
            startTelemetry() {
                setInterval(() => this.updateTelemetry(), 1000);
                this.updateTelemetry();
            },

            updateTelemetry() {
                const now = new Date();
                if (typeof SunCalc === 'undefined') return;

                const moon = SunCalc.getMoonPosition(now, State.pos.lat, State.pos.lon);
                // Get Sun Position for realistic check
                const sun = SunCalc.getPosition(now, State.pos.lat, State.pos.lon);
                const illum = SunCalc.getMoonIllumination(now);
                const times = SunCalc.getMoonTimes(now, State.pos.lat, State.pos.lon);

                if (!moon || isNaN(moon.altitude)) return;

                State.moonAz = (moon.azimuth * 180 / Math.PI) + 180;
                State.moonAlt = moon.altitude * 180 / Math.PI;
                State.dist = moon.distance;

                const sunAlt = sun.altitude * 180 / Math.PI;

                // Update UI Texts
                $('azimuth-val').textContent = formatDeg(State.moonAz);
                $('azimuth-cardinal').textContent = getCardinal(State.moonAz);
                $('moon-float-label').textContent = `${getCardinal(State.moonAz)} ${Math.round(State.moonAz)}°`;

                $('altitude-val').textContent = formatDeg(State.moonAlt);
                $('distance-val').textContent = `${formatDist(moon.distance)} km`;
                $('illum-percent').textContent = `Ilum: ${Math.round(illum.fraction * 100)}%`;

                // Phase Name Spanish
                const phases = ["Luna Nueva", "Luna Creciente", "Cuarto Creciente", "Gibosa Creciente", "Luna Llena", "Gibosa Menguante", "Cuarto Menguante", "Luna Menguante"];
                let phaseIdx = Math.round(illum.phase * 8) % 8;
                $('phase-name').innerText = phases[phaseIdx];

                // Zenith/Times
                if (times.rise && times.rise > now) {
                    $('event-type').innerText = "SALIDA";
                    $('zenith-val').textContent = formatTime(times.rise);
                } else if (times.set && times.set > now) {
                    $('event-type').innerText = "PUESTA";
                    $('zenith-val').textContent = formatTime(times.set);
                } else {
                    $('event-type').innerText = "CÉNIT";
                    $('zenith-val').textContent = "--:--";
                }

                // --- REALISTIC VISIBILITY VERDICT ---
                let visText = "VISIBLE";
                let visIcon = "ph-check-circle";
                let visColor = "text-lumina-cyber";
                let visBorder = "border-lumina-cyber";

                if (State.moonAlt < 0) {
                    visText = "NO VISIBLE (BAJO HORIZONTE)";
                    visIcon = "ph-arrow-down-right";
                    visColor = "text-gray-500";
                    visBorder = "border-gray-500";
                }
                else if (sunAlt > 10 && illum.fraction < 0.3) {
                    // Sun is high, moon is thin 
                    visText = "INVISIBLE (SOLAR)";
                    visIcon = "ph-sun";
                    visColor = "text-lumina-alert"; // Red/Warning
                    visBorder = "border-lumina-alert";
                }
                else if (sunAlt > 0 && illum.fraction < 0.5) {
                    // Sun is up but maybe visible if atmosphere is clear
                    visText = "DIFÍCIL (LUZ DE DÍA)";
                    visIcon = "ph-sun-horizon";
                    visColor = "text-orange-400";
                    visBorder = "border-orange-400";
                }
                else if (State.moonAlt < 15) {
                    visText = "OBSTRUIDO (BAJA ALT.)";
                    visIcon = "ph-warning";
                    visColor = "text-lumina-gold";
                    visBorder = "border-lumina-gold";
                }

                const vEl = $('visibility-verdict');
                const pEl = $('verdict-panel');
                vEl.innerText = visText;
                vEl.className = `text-xl md:text-2xl font-tech ${visColor}`;
                $('verdict-icon').className = `ph ${visIcon} text-4xl ${visColor}`;
                pEl.className = `glass-panel p-4 flex items-center justify-between bg-gradient-to-r from-lumina-glass to-transparent border-l-4 ${visBorder} transition-colors duration-500`;

                // Calculate Feedback
                const cardinal = getCardinal(State.moonAz);
                $('target-feedback').innerText = `ALINEACIÓN: ${cardinal} (${Math.round(State.moonAz)}°)`;

                this.drawTrajectory();
            },

            loop(t) {
                // Visuals Loop
                const ring = $('compass-ring');
                ring.style.transform = `rotate(${-State.heading}deg)`;

                $('moon-pointer').style.transform = `rotate(${State.moonAz}deg)`;

                const label = $('moon-float-label');
                if (label) {
                    // Keep text upright
                    label.style.transform = `rotate(${State.heading - State.moonAz}deg)`;
                }

                // Valid heading 0-360
                let disHead = (State.heading % 360 + 360) % 360;
                $('heading-val').textContent = formatDeg(disHead);
                $('heading-cardinal').textContent = getCardinal(State.heading);

                // --- HUD DATA UPDATES ---
                const hud = $('ar-hud');
                if (hud.style.opacity !== '0') {
                    $('hud-heading').innerText = `${formatDeg(disHead)} ${getCardinal(State.heading)}`;
                    $('hud-target').innerText = `${formatDeg(State.moonAz)} ${getCardinal(State.moonAz)}`;
                    $('hud-alt').innerText = formatDeg(State.moonAlt);
                    $('hud-dist').innerText = formatDist(State.dist) + " km";
                }

                // Target Lock Logic
                let diff = Math.abs(disHead - State.moonAz);
                if (diff > 180) diff = 360 - diff;

                const reticle = $('reticle');
                const hudBracket = $('hud-reticle-bracket');
                const azVal = $('azimuth-val');
                const status = $('lock-status');

                if (diff < 4 && State.moonAlt > 0) {
                    // LOCKED
                    reticle.classList.add('target-locked');
                    azVal.classList.add('text-locked');
                    status.innerText = "OBJETIVO FIJADO";
                    status.classList.add('text-lumina-plasma', 'animate-pulse');
                    status.classList.remove('text-gray-400');
                    if (navigator.vibrate) navigator.vibrate(50);

                    // HUD Color Logic
                    if (hudBracket) {
                        hudBracket.classList.remove('border-white/50', 'border-lumina-cyber');
                        hudBracket.classList.add('border-lumina-plasma', 'drop-shadow-[0_0_10px_#d946ef]');
                    }
                } else if (diff < 20) {
                    // NEAR
                    reticle.classList.remove('target-locked');
                    azVal.classList.remove('text-locked');
                    status.innerText = "ACERCANDO...";
                    status.classList.add('text-lumina-cyber');
                    status.classList.remove('text-gray-400', 'text-lumina-plasma', 'animate-pulse');

                    if (hudBracket) {
                        hudBracket.classList.remove('border-white/50', 'border-lumina-plasma', 'drop-shadow-[0_0_10px_#d946ef]');
                        hudBracket.classList.add('border-lumina-cyber');
                    }
                } else {
                    // SCANNING
                    reticle.classList.remove('target-locked');
                    azVal.classList.remove('text-locked');
                    status.innerText = "ESCANEANDO...";
                    status.classList.add('text-gray-400');
                    status.classList.remove('text-lumina-plasma', 'text-lumina-cyber', 'animate-pulse');

                    if (hudBracket) {
                        hudBracket.classList.remove('border-lumina-plasma', 'border-lumina-cyber', 'drop-shadow-[0_0_10px_#d946ef]');
                        hudBracket.classList.add('border-white/50');
                    }
                }

                requestAnimationFrame((timestamp) => this.loop(timestamp));
            },

            drawTrajectory() {
                const cvs = $('trajectory-canvas');
                const ctx = cvs.getContext('2d');
                const w = cvs.clientWidth;
                const h = cvs.clientHeight;

                if (cvs.width !== w) {
                    cvs.width = w;
                    cvs.height = h;
                }

                ctx.clearRect(0, 0, w, h);

                // Trajectory Curve
                ctx.beginPath();
                ctx.moveTo(0, h);
                ctx.quadraticCurveTo(w / 2, h - 180, w, h);

                const grad = ctx.createLinearGradient(0, 0, 0, h);
                grad.addColorStop(0, "rgba(56, 189, 248, 0.4)");
                grad.addColorStop(1, "rgba(56, 189, 248, 0)");

                ctx.fillStyle = grad;
                ctx.fill();
                ctx.strokeStyle = "#38bdf8";
                ctx.lineWidth = 2;
                ctx.stroke();

                // "Now" Dot
                const now = new Date();
                const times = SunCalc.getMoonTimes(now, State.pos.lat, State.pos.lon);

                if (times.rise && times.set) {
                    let start = times.rise;
                    let end = times.set;

                    if (end < start) end = new Date(end.getTime() + 24 * 60 * 60 * 1000);

                    const totalWin = end - start;
                    const elapsed = now - start;
                    let pct = elapsed / totalWin;

                    if (pct < 0) pct = 0; if (pct > 1) pct = 1;

                    const inv = 1 - pct;
                    const x = (inv * inv * 0) + (2 * inv * pct * (w / 2)) + (pct * pct * w);
                    const y = (inv * inv * h) + (2 * inv * pct * (h - 180)) + (pct * pct * h);

                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, Math.PI * 2);
                    ctx.fillStyle = "#fbbf24";
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = "#fbbf24";
                    ctx.fill();

                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x, h);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = "rgba(251, 191, 36, 0.5)";
                    ctx.setLineDash([4, 4]);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    ctx.fillStyle = "#fbbf24";
                    ctx.font = "10px Orbitron";
                    ctx.textAlign = "center";
                    ctx.fillText("AHORA", x, y - 10);
                }
            },

            showPaywall() {
                if (State.isPro) return;
                const modal = $('paywall-modal');
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('div').classList.remove('translate-y-10');
            },

            hidePaywall() {
                const modal = $('paywall-modal');
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.querySelector('div').classList.add('translate-y-10');
            },

            processUpgrade() {
                const btn = $('sim-pay-btn');
                btn.innerHTML = "<i class='ph ph-spinner animate-spin'></i> AUTENTICANDO...";
                setTimeout(() => {
                    btn.classList.replace('bg-lumina-gold', 'bg-green-500');
                    btn.innerHTML = "ACCESO CONCEDIDO";
                    State.isPro = true;
                    setTimeout(() => {
                        this.hidePaywall();
                        $$('.paywall-lock').forEach(el => {
                            el.classList.remove('opacity-60', 'cursor-pointer');
                            el.classList.add('border-lumina-gold');
                            const icon = el.querySelector('.ph-lock-key');
                            if (icon) icon.className = "ph ph-check-circle text-green-500 mt-2";
                        });
                        $('paywall-btn-top').classList.add('bg-lumina-gold/20');
                        $('paywall-btn-top').innerHTML = '<span class="text-xs font-bold text-lumina-gold">PRO ACTIVO</span>';
                    }, 1000);
                }, 1500);
            }
        };

        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>

</html>