<!doctype html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="theme-color" content="#050505" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>Lumina: Orbital Command</title>

    <!-- PWA Manifest Simulation -->
    <link
      rel="manifest"
      href="data:application/json;base64,eyJuYW1lIjoiTHVtaW5hIFBybyIsInNob3J0X25hbWUiOiJMdW1pbmEiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzA1MDUwNSIsInRoZW1lX2NvbG9yIjoiIzM4YmRmOCIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2ltZy5pY29uczhjb20vY29sb3IvOTYvMDAwMDAwL21vb24tc2F0ZWxsaXRlLnBuZyIsInNpemVzIjoiOTZ4OTYiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ=="
    />

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              void: "#050505",
              deep: "#0a0a10",
              glass: "rgba(20, 20, 25, 0.7)",
              primary: "#38bdf8", // Sky Blue
              accent: "#d946ef", // Fuchsia
              gold: "#fbbf24",
              success: "#10b981",
              warning: "#f59e0b",
              danger: "#f43f5e",
            },
            fontFamily: {
              mono: ['"Orbitron"', "sans-serif"],
              sans: ['"Rajdhani"', "sans-serif"],
            },
            boxShadow: {
              "glow-sm": "0 0 10px rgba(56, 189, 248, 0.2)",
              "glow-primary": "0 0 20px rgba(56, 189, 248, 0.3)",
              "glow-accent": "0 0 25px rgba(217, 70, 239, 0.3)",
              panel: "0 8px 32px 0 rgba(0, 0, 0, 0.3)",
            },
            backgroundImage: {
              "tech-grid":
                "radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px)",
              scanline:
                "linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2))",
            },
            animation: {
              "spin-slow": "spin 120s linear infinite",
              float: "float 6s ease-in-out infinite",
            },
            keyframes: {
              float: {
                "0%, 100%": { transform: "translateY(0)" },
                "50%": { transform: "translateY(-10px)" },
              },
            },
          },
        },
      };
    </script>

    <style>
      :root {
        --panel-bg: rgba(15, 15, 20, 0.65);
      }
      body {
        background-color: #050505;
        color: #e2e8f0;
        overflow: hidden;
        font-family: "Rajdhani", sans-serif;
        -webkit-font-smoothing: antialiased;
      }

      /* Grain Texture */
      .noise-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        pointer-events: none;
        z-index: 5;
        opacity: 0.4;
      }

      /* Premium Panels */
      .hud-module {
        background: var(--panel-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .hud-module:hover {
        border-color: rgba(56, 189, 248, 0.2);
        box-shadow: 0 0 15px rgba(56, 189, 248, 0.1);
      }

      /* Typography */
      .label-tech {
        font-weight: 700;
        font-size: 0.65rem;
        letter-spacing: 0.15em;
        color: #94a3b8;
        text-transform: uppercase;
      }
      .value-tech {
        font-family: "Orbitron", sans-serif;
        letter-spacing: 0.02em;
      }

      /* Compass */
      .compass-lens {
        border-radius: 50%;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(255, 255, 255, 0.02) 0%,
          rgba(0, 0, 0, 0.8) 90%
        );
        box-shadow:
          0 0 0 1px rgba(255, 255, 255, 0.05),
          inset 0 0 50px rgba(0, 0, 0, 0.9);
        position: relative;
      }
      .dial-ring {
        transition: transform 0.1s linear;
        will-change: transform;
      }
      .smooth-move {
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      } /* Bouncy */

      .tick-mark {
        position: absolute;
        left: 50%;
        transform-origin: bottom center;
        background: rgba(255, 255, 255, 0.3);
      }
      .tick-major {
        height: 10px;
        width: 2px;
        background: #38bdf8;
        box-shadow: 0 0 8px rgba(56, 189, 248, 0.5);
      }
      .tick-minor {
        height: 5px;
        width: 1px;
        opacity: 0.3;
      }

      .locked .compass-lens {
        border-color: rgba(217, 70, 239, 0.5);
        box-shadow:
          inset 0 0 40px rgba(217, 70, 239, 0.2),
          0 0 30px rgba(217, 70, 239, 0.15);
      }

      /* Navigation */
      .nav-dock {
        background: rgba(10, 10, 12, 0.85);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(20px);
        padding-bottom: env(safe-area-inset-bottom);
        z-index: 50;
      }
      .nav-item {
        color: #64748b;
        transition: all 0.3s ease;
        position: relative;
      }
      .nav-item:hover {
        color: #e2e8f0;
      }
      .nav-item.active {
        color: #38bdf8;
      }
      .nav-item.active::after {
        content: "";
        position: absolute;
        bottom: -4px;
        width: 4px;
        height: 4px;
        background: #38bdf8;
        border-radius: 50%;
        box-shadow: 0 0 8px #38bdf8;
      }

      /* Desktop Sidebar Transition */
      @media (min-width: 1024px) {
        .nav-dock {
          top: 50%;
          left: 1.5rem;
          transform: translateY(-50%);
          width: 4rem;
          height: auto;
          flex-direction: column;
          border-top: 1px solid rgba(255, 255, 255, 0.08); /* Reset */
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 20px;
          padding-bottom: 1rem;
          padding-top: 1rem;
          gap: 1.5rem;
        }
        .nav-item.active::after {
          right: -8px;
          bottom: 50%;
          transform: translateY(50%);
        }

        /* Main Content Scroll Adjustment */
        #views-container {
          padding-left: 6rem;
          padding-bottom: 2rem;
        }
      }

      /* Elements */
      #ar-video {
        object-fit: cover;
        width: 100%;
        height: 100%;
        position: absolute;
        inset: 0;
        z-index: 0;
      }
      canvas {
        image-rendering: pixelated;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body
    class="bg-void h-screen w-screen flex flex-col relative selection:bg-accent selection:text-white"
  >
    <div class="noise-overlay"></div>
    <div
      class="absolute inset-0 bg-tech-grid bg-[length:40px_40px] opacity-20 pointer-events-none"
    ></div>
    <div class="absolute inset-0 bg-scanline pointer-events-none z-[2]"></div>

    <!-- BOOT SEQUENCE (Unchanged logic) -->
    <div
      id="boot-sequence"
      class="fixed inset-0 z-[100] bg-void flex flex-col items-center justify-center p-8 transition-opacity duration-700"
    >
      <div class="relative w-48 h-48 flex items-center justify-center mb-10">
        <div
          class="absolute inset-0 border border-primary/20 rounded-full animate-[spin_10s_linear_infinite]"
        ></div>
        <div
          class="absolute inset-4 border border-t-primary border-r-transparent border-b-transparent border-l-transparent rounded-full animate-[spin_3s_linear_infinite]"
        ></div>
        <div
          class="absolute inset-8 border border-b-accent border-t-transparent border-l-transparent border-r-transparent rounded-full animate-[spin_2s_linear_infinite_reverse]"
        ></div>
        <div class="relative z-10 flex flex-col items-center animate-pulse">
          <i
            class="ph-duotone ph-planet text-6xl text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]"
          ></i>
        </div>
      </div>
      <h1
        class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-white to-purple-500 font-mono tracking-tighter mb-4 drop-shadow-2xl"
      >
        LUMINA
      </h1>
      <button
        id="system-start-btn"
        class="group relative px-12 py-4 overflow-hidden bg-white/5 border border-white/10 hover:border-purple-500/50 hover:bg-purple-500/10 rounded transition-all duration-500"
      >
        <span
          class="relative text-sm font-mono font-bold text-white group-hover:text-purple-400 transition-colors tracking-[0.2em] flex items-center gap-3"
        >
          INICIAR SISTEMA <i class="ph-bold ph-caret-right"></i>
        </span>
      </button>
    </div>

    <!-- MAIN APP STRUCTURE -->
    <div
      id="main-app"
      class="flex-1 flex flex-col h-full opacity-0 transition-opacity duration-1000 relative overflow-hidden"
    >
      <!-- HEADER: Sticky Top w/ Glass -->
      <header
        class="flex justify-between items-start px-6 pt-6 pb-2 z-30 absolute w-full top-0 pointer-events-none lg:px-10 lg:pt-8"
      >
        <div class="pointer-events-auto flex flex-col gap-1">
          <div class="flex items-center gap-3">
            <span class="relative flex h-2 w-2">
              <span
                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-500 opacity-75"
              ></span>
              <span
                class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"
              ></span>
            </span>
            <span
              id="user-tier"
              class="text-[10px] font-mono font-bold text-emerald-500 tracking-[0.2em]"
              >ONLINE</span
            >
          </div>
          <div
            class="text-[10px] font-mono text-gray-400 flex items-center gap-1"
            id="gps-coords"
          >
            <i class="ph-bold ph-crosshair-simple"></i> GPS: BUSCANDO...
          </div>
        </div>
        <div class="text-right pointer-events-auto">
          <div class="flex items-center justify-end gap-3 mb-1">
            <button
              id="header-install-btn"
              onclick="installApp()"
              class="hidden bg-white/10 text-white text-[9px] font-bold px-3 py-1 rounded-full border border-white/20 hover:bg-white/20 transition-colors mr-2"
            >
              <i class="ph-bold ph-download-simple"></i> INSTALAR
            </button>
            <button
              id="upgrade-btn"
              class="bg-gradient-to-r from-amber-500 to-orange-600 text-black text-[9px] font-bold px-3 py-1 rounded-full shadow-glow-sm hover:scale-105 transition-transform"
            >
              <i class="ph-fill ph-crown"></i> PRO
            </button>
          </div>
          <div
            id="clock"
            class="text-2xl font-mono font-bold text-white leading-none drop-shadow-md"
          >
            00:00
          </div>
          <div
            id="date"
            class="text-[10px] font-sans font-bold text-primary tracking-widest mt-0.5 opacity-80"
          >
            -- ---
          </div>
        </div>
      </header>

      <!-- VIEW CONTAINER -->
      <div
        class="flex-1 relative overflow-y-auto overflow-x-hidden pt-24 pb-28 lg:pb-8 lg:pt-28 lg:pl-32 scroll-smooth"
        id="views-container"
      >
        <!-- [VIEW 1] COMMAND DASHBOARD (Responsive Grid) -->
        <section
          id="view-home"
          class="view-section min-h-full px-4 lg:px-10 max-w-[1920px] mx-auto"
        >
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
            <!-- LEFT COL: COMPASS (Desktop: Col 1-4) -->
            <div
              class="lg:col-span-4 flex flex-col items-center justify-center"
            >
              <!-- Compass Module -->
              <div
                class="relative w-full aspect-square max-w-[400px] flex items-center justify-center group"
              >
                <!-- Decor Rings -->
                <div
                  class="absolute w-[90%] h-[90%] border border-white/5 rounded-full pointer-events-none group-hover:border-white/10 transition-colors duration-700"
                ></div>
                <div
                  class="absolute w-[98%] h-[98%] border border-dashed border-white/5 rounded-full pointer-events-none animate-[spin_60s_linear_infinite] opacity-50"
                ></div>

                <!-- Main Lens -->
                <div
                  class="relative w-[80%] h-[80%] flex items-center justify-center compass-lens transition-all duration-300 backdrop-blur-sm"
                  id="compass-unit"
                >
                  <div
                    class="absolute top-0 z-50 w-1 h-6 bg-primary rounded-full shadow-glow-primary"
                  ></div>

                  <div
                    id="compass-dial"
                    class="dial-ring w-full h-full rounded-full relative"
                  >
                    <div
                      id="ticks-layer"
                      class="w-full h-full absolute inset-0 opacity-80"
                    ></div>
                    <!-- Cardinals -->
                    <div class="absolute inset-0 z-30 pointer-events-none">
                      <span
                        class="absolute top-4 left-1/2 -translate-x-1/2 text-xl font-mono font-black text-white drop-shadow-md"
                        >N</span
                      >
                      <span
                        class="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-mono font-bold text-gray-500"
                        >E</span
                      >
                      <span
                        class="absolute bottom-4 left-1/2 -translate-x-1/2 text-xs font-mono font-bold text-gray-500"
                        >S</span
                      >
                      <span
                        class="absolute left-4 top-1/2 -translate-y-1/2 text-xs font-mono font-bold text-gray-500"
                        >O</span
                      >
                    </div>
                    <!-- Moon Pointer -->
                    <div
                      id="moon-pointer"
                      class="absolute inset-0 z-20 smooth-move"
                    >
                      <div
                        class="absolute top-10 left-1/2 -translate-x-1/2 flex flex-col items-center group-hover:scale-110 transition-transform"
                      >
                        <i
                          id="moon-icon"
                          class="ph-fill ph-moon-stars text-4xl text-gray-300 drop-shadow-lg"
                        ></i>
                        <div
                          id="azimuth-pill"
                          class="mt-2 bg-deep/80 backdrop-blur px-2 py-0.5 rounded text-[9px] font-mono text-gray-400 border border-white/10"
                        >
                          ---
                        </div>
                      </div>
                    </div>
                  </div>

                  <div
                    id="lock-alert"
                    class="absolute inset-0 flex items-center justify-center opacity-0 scale-75 transition-all duration-300 pointer-events-none active-layer"
                  >
                    <div
                      class="bg-black/90 border border-accent text-accent px-4 py-1 rounded text-xs font-mono font-bold tracking-[0.3em] shadow-glow-accent animate-pulse"
                    >
                      LOCKED
                    </div>
                  </div>
                </div>
              </div>

              <!-- Readouts -->
              <div
                class="w-full flex justify-between px-4 lg:px-10 mt-4 pointer-events-none max-w-[400px]"
              >
                <div class="text-left">
                  <div class="label-tech text-primary mb-1">RUMBO ACTUAL</div>
                  <div
                    id="heading-val"
                    class="text-3xl font-mono font-bold text-white tracking-tighter"
                  >
                    000°
                  </div>
                </div>
                <div class="text-right">
                  <div class="label-tech text-accent mb-1">OBJETIVO</div>
                  <div
                    id="target-val"
                    class="text-3xl font-mono font-bold text-gray-500 tracking-tighter"
                  >
                    ---°
                  </div>
                </div>
              </div>
            </div>

            <!-- MID COL: TELEMETRY (Desktop: Col 5-8) -->
            <div class="lg:col-span-4 flex flex-col justify-center gap-4">
              <!-- Status Panel -->
              <div
                class="hud-module p-5 flex items-center justify-between border-l-4 border-gray-600 transition-colors duration-500 group"
                id="status-bar"
              >
                <div class="flex flex-col">
                  <span
                    class="label-tech group-hover:text-white transition-colors"
                    >ESTADO DE OBSERVACIÓN</span
                  >
                  <div
                    id="vis-verdict"
                    class="text-2xl font-sans font-bold text-white leading-none mt-2 tracking-wide"
                  >
                    ANALIZANDO...
                  </div>
                </div>
                <div class="text-right">
                  <div
                    id="vis-icon-container"
                    class="bg-white/5 p-3 rounded-xl border border-white/5 group-hover:bg-white/10 transition-colors"
                  >
                    <i
                      id="vis-icon"
                      class="ph-fill ph-broadcast text-2xl text-gray-500"
                    ></i>
                  </div>
                </div>
              </div>

              <!-- Grid Data -->
              <div class="grid grid-cols-2 gap-4">
                <!-- Moon Card -->
                <div
                  class="hud-module p-4 flex flex-col gap-3 hover:-translate-y-1 transition-transform"
                >
                  <div
                    class="flex justify-between items-center border-b border-white/5 pb-2"
                  >
                    <span class="label-tech text-accent"
                      ><i class="ph-bold ph-planet"></i> LUNA</span
                    >
                    <span
                      id="phase-val"
                      class="text-[10px] font-mono text-white opacity-80"
                      >--%</span
                    >
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <div>
                      <span class="label-tech block mb-0.5">ILUM</span
                      ><span
                        id="illum-val"
                        class="value-tech text-lg font-bold text-white"
                        >--%</span
                      >
                    </div>
                    <div class="text-right">
                      <span class="label-tech block mb-0.5">DIST</span
                      ><span
                        id="dist-val"
                        class="value-tech text-lg font-bold text-primary"
                        >--K</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Pos Card -->
                <div
                  class="hud-module p-4 flex flex-col gap-3 hover:-translate-y-1 transition-transform"
                >
                  <div
                    class="flex justify-between items-center border-b border-white/5 pb-2"
                  >
                    <span class="label-tech text-primary"
                      ><i class="ph-bold ph-crosshair"></i> POSICIÓN</span
                    >
                    <span
                      id="alt-val"
                      class="text-[10px] font-mono text-white opacity-80"
                      >ALT: --°</span
                    >
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <div>
                      <span class="label-tech block mb-0.5">PICO</span
                      ><span
                        id="peak-val"
                        class="value-tech text-lg font-bold text-warning"
                        >--:--</span
                      >
                    </div>
                    <div class="text-right">
                      <span class="label-tech block mb-0.5">AZIMUT</span
                      ><span
                        id="az-grid-val"
                        class="value-tech text-lg font-bold text-white"
                        >--</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Cycle -->
                <div
                  class="hud-module p-4 hover:-translate-y-1 transition-transform"
                >
                  <span class="label-tech block mb-3">CICLO DIARIO</span>
                  <div
                    class="flex justify-between items-center bg-black/30 rounded-lg p-2 border border-white/5"
                  >
                    <div class="text-center">
                      <i
                        class="ph-bold ph-arrow-up text-primary text-xs mb-1 block"
                      ></i>
                      <div
                        id="rise-val"
                        class="text-sm font-mono font-bold text-white"
                      >
                        --:--
                      </div>
                    </div>
                    <div class="h-8 w-[1px] bg-white/10"></div>
                    <div class="text-center">
                      <i
                        class="ph-bold ph-arrow-down text-accent text-xs mb-1 block"
                      ></i>
                      <div
                        id="set-val"
                        class="text-sm font-mono font-bold text-white"
                      >
                        --:--
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Atmosphere -->
                <div
                  class="hud-module p-4 hover:-translate-y-1 transition-transform"
                >
                  <span class="label-tech block mb-3">ATMÓSFERA</span>
                  <div class="grid grid-cols-2 gap-2">
                    <div class="flex flex-col">
                      <span class="text-[9px] text-gray-500 font-mono mb-1"
                        >NUBES</span
                      >
                      <span
                        id="cloud-val"
                        class="text-lg font-mono font-bold text-white"
                        >--%</span
                      >
                    </div>
                    <div class="flex flex-col text-right">
                      <span class="text-[9px] text-gray-500 font-mono mb-1"
                        >HUM</span
                      >
                      <span
                        id="humid-val"
                        class="text-lg font-mono font-bold text-primary"
                        >--%</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT COL: GRAPH / TOOLS (Desktop: Col 9-12) -->
            <div class="lg:col-span-4 flex flex-col gap-4">
              <!-- Graph -->
              <div
                class="hud-module p-0 relative h-64 lg:h-auto lg:flex-1 flex flex-col"
              >
                <div class="absolute top-4 left-5 z-10 pointer-events-none">
                  <span class="label-tech text-accent block tracking-widest"
                    >TRAYECTORIA PICO</span
                  >
                  <span class="text-[9px] text-gray-500 font-mono"
                    >ELEVACIÓN 24 HORAS</span
                  >
                </div>

                <canvas
                  id="graph-canvas"
                  class="w-full h-full absolute inset-0"
                ></canvas>

                <!-- Sim Button -->
                <button
                  id="future-btn"
                  class="absolute top-4 right-4 bg-white/5 hover:bg-accent hover:text-white border border-white/10 text-gray-400 text-[10px] font-mono font-bold px-3 py-1.5 rounded transition-all z-10 backdrop-blur-md"
                >
                  <i class="ph-bold ph-clock"></i> SIMULAR
                </button>
              </div>

              <!-- Sim Panel (Collapsible) -->
              <div
                id="future-panel"
                class="hidden hud-module p-5 border-t-2 border-accent animate-[fadeIn_0.3s_ease]"
              >
                <div class="flex justify-between items-center mb-4">
                  <span class="label-tech text-accent">SIMULADOR ORBITAL</span
                  ><button
                    id="close-future"
                    class="text-gray-400 hover:text-white"
                  >
                    <i class="ph-bold ph-x"></i>
                  </button>
                </div>
                <div class="flex gap-2 mb-4">
                  <input
                    type="datetime-local"
                    id="f-input"
                    class="w-full bg-deep border border-white/10 rounded-lg px-3 py-2 text-xs text-white font-mono outline-none focus:border-accent focus:ring-1 focus:ring-accent transition-all"
                  />
                </div>
                <button
                  id="f-calc"
                  class="w-full bg-accent/10 border border-accent/50 text-accent hover:bg-accent hover:text-white py-2 rounded-lg font-mono font-bold text-xs tracking-widest transition-all"
                >
                  CALCULAR VIABILIDAD
                </button>
                <div id="f-result" class="mt-4 text-center hidden"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- [VIEW 2] AR -->
        <section
          id="view-ar"
          class="view-section hidden h-full w-full relative bg-black"
        >
          <!-- Copied logic from source, kept clean -->
          <div
            id="ar-container"
            class="absolute inset-0 flex flex-col items-center justify-center overflow-hidden"
          >
            <video
              id="ar-video"
              playsinline
              autoplay
              muted
              class="opacity-70"
            ></video>
            <!-- HUD Elements -->
            <div class="absolute inset-0 z-10 pointer-events-none">
              <div
                class="absolute top-8 left-8 w-16 h-16 border-t-2 border-l-2 border-primary/50 rounded-tl-2xl"
              ></div>
              <div
                class="absolute top-8 right-8 w-16 h-16 border-t-2 border-r-2 border-primary/50 rounded-tr-2xl"
              ></div>
              <div
                class="absolute bottom-32 left-8 w-16 h-16 border-b-2 border-l-2 border-primary/50 rounded-bl-2xl"
              ></div>
              <div
                class="absolute bottom-32 right-8 w-16 h-16 border-b-2 border-r-2 border-primary/50 rounded-br-2xl"
              ></div>

              <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-72 h-72 border border-white/10 rounded-full flex items-center justify-center"
              >
                <div
                  class="w-1 h-5 bg-primary absolute top-0 shadow-glow-primary"
                ></div>
                <div class="w-1 h-5 bg-primary absolute bottom-0"></div>
                <div class="w-5 h-1 bg-primary absolute left-0"></div>
                <div class="w-5 h-1 bg-primary absolute right-0"></div>
                <div
                  class="w-2 h-2 bg-accent rounded-full animate-pulse shadow-glow-accent"
                ></div>
              </div>
              <div
                class="absolute top-12 left-1/2 -translate-x-1/2 bg-deep/80 backdrop-blur px-6 py-2 rounded-full border border-white/10"
              >
                <span
                  class="text-xs font-mono text-primary font-bold"
                  id="ar-heading"
                  >RUMBO: ---°</span
                >
              </div>
            </div>
          </div>
        </section>

        <!-- [VIEW 3] MAP -->
        <section
          id="view-map"
          class="view-section hidden h-full p-4 lg:p-10 flex flex-col gap-6 max-w-5xl mx-auto"
        >
          <h2
            class="text-2xl font-bold font-mono text-gold mb-2 flex items-center gap-3"
          >
            <i class="ph-fill ph-map-trifold"></i> MAPA DE CONTAMINACIÓN
            <span
              class="bg-gold text-black text-[10px] px-2 py-0.5 rounded font-bold"
              >PRO</span
            >
          </h2>
          <div
            class="hud-module h-[60vh] relative flex items-center justify-center overflow-hidden group border-gold/20 hover:border-gold/50 transition-colors"
          >
            <div
              class="absolute inset-0 bg-[url('https://upload.wikimedia.org/wikipedia/commons/8/86/Earth_lights_vs_population_density.png')] bg-cover bg-center opacity-40 grayscale group-hover:grayscale-0 transition-all duration-1000 scale-105 group-hover:scale-100"
            ></div>
            <div
              class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center text-center p-6 backdrop-blur-sm transition-opacity"
              id="map-lock-overlay"
            >
              <i
                class="ph-fill ph-lock-key text-5xl text-gold mb-4 drop-shadow-lg"
              ></i>
              <h3 class="text-xl font-bold text-white mb-2 font-mono">
                ACCESO RESTRINGIDO
              </h3>
              <p class="text-xs text-gray-400 mb-6 max-w-xs">
                Los mapas de alta resolución requieren credenciales de nivel
                PRO.
              </p>
              <button
                onclick="openPaywall()"
                class="bg-gold text-black font-bold px-8 py-3 rounded-lg hover:scale-105 transition-transform shadow-[0_0_20px_#fbbf24] tracking-widest text-xs font-mono"
              >
                DESBLOQUEAR
              </button>
            </div>
          </div>
        </section>

        <!-- [VIEW 4] TOOLS -->
        <section
          id="view-tools"
          class="view-section hidden h-full p-4 lg:p-10 pb-32 max-w-4xl mx-auto"
        >
          <h2
            class="text-2xl font-bold font-mono text-white mb-6 flex items-center gap-3"
          >
            <i class="ph-fill ph-toolbox"></i> EQUIPAJE TÁCTICO
          </h2>

          <div
            class="hud-module p-6 mb-6 border-l-4 border-gold bg-gradient-to-r from-gold/5 to-transparent"
          >
            <div class="flex justify-between items-start mb-4">
              <h3 class="text-base font-bold text-gold tracking-widest">
                CALCULADORA DE EXPOSICIÓN
              </h3>
              <i class="ph-fill ph-camera text-gold text-xl"></i>
            </div>
            <div class="relative py-4">
              <div
                class="grid grid-cols-2 lg:grid-cols-4 gap-4 blur-sm select-none opacity-50"
              >
                <div class="bg-black/40 p-3 rounded border border-white/5">
                  <span class="label-tech block">ISO</span>
                  <div class="text-white font-mono text-lg">100</div>
                </div>
                <div class="bg-black/40 p-3 rounded border border-white/5">
                  <span class="label-tech block">f/STOP</span>
                  <div class="text-white font-mono text-lg">f/2.8</div>
                </div>
                <div class="bg-black/40 p-3 rounded border border-white/5">
                  <span class="label-tech block">REGLA 500</span>
                  <div class="text-white font-mono text-lg">12s</div>
                </div>
                <div class="bg-black/40 p-3 rounded border border-white/5">
                  <span class="label-tech block">LENTE</span>
                  <div class="text-white font-mono text-lg">24mm</div>
                </div>
              </div>
              <div class="absolute inset-0 flex items-center justify-center">
                <button
                  onclick="openPaywall()"
                  class="bg-gold text-black text-xs font-bold px-6 py-2 rounded-full shadow-[0_0_15px_#fbbf24] flex items-center gap-2 hover:bg-white transition-colors"
                >
                  <i class="ph-bold ph-lock-key"></i> ACCEDER AL KIT
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- NAV DOCK (Responsive: Bottom Mobile, Side Desktop) -->
      <nav
        class="nav-dock fixed bottom-0 w-full flex justify-around items-center px-2 py-3 lg:flex-col lg:justify-start lg:w-20 lg:h-auto lg:top-1/2 lg:left-6 lg:rounded-2xl lg:border lg:py-6 lg:bg-deep/90"
      >
        <button
          class="nav-item active flex flex-col items-center gap-1 w-16 lg:w-full group"
          onclick="switchView('view-home', this)"
        >
          <i
            class="ph-fill ph-crosshair text-2xl group-hover:scale-110 transition-transform"
          ></i>
          <span class="text-[8px] font-bold tracking-widest mt-1 opacity-70"
            >CMD</span
          >
        </button>
        <button
          class="nav-item flex flex-col items-center gap-1 w-16 lg:w-full group text-gray-500"
          onclick="switchView('view-ar', this)"
        >
          <i
            class="ph-fill ph-camera text-2xl group-hover:scale-110 transition-transform"
          ></i>
          <span class="text-[8px] font-bold tracking-widest mt-1 opacity-70"
            >AR</span
          >
        </button>
        <button
          class="nav-item flex flex-col items-center gap-1 w-16 lg:w-full group text-gray-500"
          onclick="switchView('view-map', this)"
        >
          <i
            class="ph-fill ph-map-trifold text-2xl group-hover:scale-110 transition-transform"
          ></i>
          <span class="text-[8px] font-bold tracking-widest mt-1 opacity-70"
            >MAPA</span
          >
        </button>
        <button
          class="nav-item flex flex-col items-center gap-1 w-16 lg:w-full group text-gray-500"
          onclick="switchView('view-tools', this)"
        >
          <i
            class="ph-fill ph-toolbox text-2xl group-hover:scale-110 transition-transform"
          ></i>
          <span class="text-[8px] font-bold tracking-widest mt-1 opacity-70"
            >KIT</span
          >
        </button>
      </nav>
    </div>

    <!-- PAYWALL MODAL -->
    <div
      id="paywall-modal"
      class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-xl flex items-center justify-center p-6 hidden opacity-0 transition-opacity duration-300"
    >
      <div
        class="bg-gray-900 border border-gold rounded-2xl p-8 max-w-sm w-full relative shadow-[0_0_50px_rgba(251,191,36,0.2)] transform transition-transform scale-95"
        id="paywall-content"
      >
        <div
          class="absolute -top-10 left-1/2 -translate-x-1/2 w-20 h-20 bg-gray-900 rounded-full border border-gold flex items-center justify-center shadow-lg"
        >
          <i class="ph-fill ph-crown text-4xl text-gold"></i>
        </div>
        <button
          onclick="closePaywall()"
          class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors"
        >
          <i class="ph-bold ph-x text-xl"></i>
        </button>

        <div class="text-center mt-8 mb-6">
          <h2 class="text-3xl font-bold text-white font-mono tracking-tighter">
            LUMINA <span class="text-gold">PRO</span>
          </h2>
          <div class="h-0.5 w-12 bg-gold mx-auto my-3"></div>
          <p class="text-gray-400 text-sm leading-relaxed">
            Acceso a Mapas de Contaminación Lumínica, Calculadora de
            Astrofotografía y Telemetría Extendida.
          </p>
        </div>

        <ul class="space-y-3 mb-8 text-left text-sm text-gray-300">
          <li class="flex items-center gap-3">
            <i class="ph-bold ph-check text-success"></i>
            <span>Mapas de Satélite HD</span>
          </li>
          <li class="flex items-center gap-3">
            <i class="ph-bold ph-check text-success"></i>
            <span>Sin Anuncios</span>
          </li>
          <li class="flex items-center gap-3">
            <i class="ph-bold ph-check text-success"></i>
            <span>Soporte Prioritario</span>
          </li>
        </ul>

        <button
          onclick="processPayment()"
          class="w-full bg-gradient-to-r from-gold to-orange-500 text-black font-bold py-4 rounded-xl hover:scale-[1.02] active:scale-[0.98] transition-all shadow-glow-sm tracking-widest text-sm font-mono"
          id="pay-btn"
        >
          SUSCRIBIRSE - $2.99 / MES
        </button>
      </div>
    </div>

    <script>
      // --- UTILS ---
      const $ = (id) => document.getElementById(id);
      const safeText = (id, txt) => {
        const el = $(id);
        if (el) el.innerText = txt;
      };

      // --- HELPER: CARDINAL DIRECTION ---
      function getCardinal(angle) {
        const directions = [
          "N",
          "NNE",
          "NE",
          "ENE",
          "E",
          "ESE",
          "SE",
          "SSE",
          "S",
          "SSO",
          "SO",
          "OSO",
          "O",
          "ONO",
          "NO",
          "NNO",
        ];
        const normalized = ((angle % 360) + 360) % 360;
        const index = Math.round(normalized / 22.5) % 16;
        return directions[index];
      }

      // --- STATE ---
      const sys = {
        lat: null,
        lon: null,
        heading: 0,
        accumHeading: 0,
        lastRawHeading: 0,
        moonAz: 0,
        moonAlt: 0,
        moonDist: 0,
        isLocked: false,
        clouds: 0,
        humidity: 0,
        isPro: false,
      };

      // --- PWA & SERVICE WORKER ---
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js").then(
            (reg) => console.log("SW Registered"),
            (err) => console.log("SW Failed", err),
          );
        });
      }

      let deferredPrompt;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Show install trigger in header if available
        const installBtn = document.getElementById("header-install-btn");
        if (installBtn) installBtn.classList.remove("hidden");
      });

      async function installApp() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        if (outcome === "accepted") {
          const b = document.getElementById("header-install-btn");
          if (b) b.classList.add("hidden");
        }
      }

      // --- TICKS & SETUP ---
      const ticksLayer = $("ticks-layer");
      if (ticksLayer) {
        for (let i = 0; i < 360; i += 2) {
          if (i % 90 === 0) continue;
          const el = document.createElement("div");
          el.className = `tick-mark ${i % 10 === 0 ? "tick-major" : "tick-minor"}`;
          // Ticks positioning
          el.style.top = "50%";
          el.style.left = "50%";
          // The radius needs to match 80% of compass container roughly.
          // Container is ~400px max on desktop, smaller on mobile.
          // We use % translation to be responsive inside the lens.
          el.style.transform = `translate(-50%, -50%) rotate(${i}deg) translateY(-40%)`;
          // translateY -40% pushes it to the edge of the lens (which is 100% height)
          ticksLayer.appendChild(el);
        }
      }

      // --- INIT ---
      $("system-start-btn").addEventListener("click", async () => {
        if (
          typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function"
        ) {
          try {
            await DeviceOrientationEvent.requestPermission();
          } catch (e) {}
        }
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(handleGPS, null, {
            enableHighAccuracy: true,
          });
        }

        if ("ondeviceorientationabsolute" in window)
          window.addEventListener(
            "deviceorientationabsolute",
            handleOrientation,
          );
        else window.addEventListener("deviceorientation", handleOrientation);

        $("boot-sequence").style.opacity = "0";
        setTimeout(() => {
          $("boot-sequence").style.display = "none";
          $("main-app").style.opacity = "1";
          startLoops();
        }, 800);
      });

      function startLoops() {
        setInterval(() => {
          const now = new Date();
          safeText("clock", now.toLocaleTimeString("es-ES", { hour12: false }));
          safeText(
            "date",
            now
              .toLocaleDateString("es-ES", {
                day: "2-digit",
                month: "short",
                year: "numeric",
              })
              .toUpperCase()
              .replace(".", ""),
          );
        }, 1000);

        setInterval(() => {
          if (sys.lat) updateTelemetry();
        }, 1000);
        const now = new Date();
        const pad = (n) => n.toString().padStart(2, "0");
        const fi = $("f-input");
        if (fi)
          fi.value = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;

        setTimeout(() => drawConeGraph(now), 100); // Wait for layout
        window.addEventListener("resize", () => drawConeGraph(new Date()));
      }

      function handleGPS(pos) {
        sys.lat = pos.coords.latitude;
        sys.lon = pos.coords.longitude;
        safeText(
          "gps-coords",
          `GPS: ${sys.lat.toFixed(4)}, ${sys.lon.toFixed(4)}`,
        );
        fetchWeather();
        drawConeGraph(new Date());
        updateTelemetry();
      }

      async function fetchWeather() {
        if (!sys.lat) return;
        try {
          const r = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${sys.lat}&longitude=${sys.lon}&current=cloud_cover,relative_humidity_2m&timezone=auto`,
          );
          const d = await r.json();
          sys.clouds = d.current.cloud_cover;
          sys.humidity = d.current.relative_humidity_2m;
        } catch (e) {}
      }

      function handleOrientation(e) {
        let alpha = e.alpha;
        if (e.webkitCompassHeading) alpha = e.webkitCompassHeading;
        else alpha = 360 - alpha;

        if (alpha === null || isNaN(alpha)) return;

        let heading = alpha;

        // Initialize lastRawHeading on first run
        if (sys.lastRawHeading === undefined) sys.lastRawHeading = heading;

        // Smooth rotation logic: calculate shortest path
        let delta = heading - sys.lastRawHeading;
        if (delta < -180) delta += 360;
        else if (delta > 180) delta -= 360;

        sys.accumHeading += delta;
        sys.lastRawHeading = heading;
        sys.heading = heading;

        // Display 0-360 for text
        let displayHeading = ((heading % 360) + 360) % 360;

        safeText("heading-val", `${Math.round(displayHeading)}°`);
        safeText(
          "ar-heading",
          `RUMBO: ${Math.round(displayHeading)}° ${getCardinal(displayHeading)}`,
        );

        const cd = $("compass-dial");
        // Apply negative ACCUMULATED heading to rotating dial
        if (cd) cd.style.transform = `rotate(${-sys.accumHeading}deg)`;

        const mp = $("moon-pointer");
        if (mp) mp.style.transform = `rotate(${sys.moonAz}deg)`;

        let diff = Math.abs(displayHeading - sys.moonAz);
        if (diff > 180) diff = 360 - diff;
        if (diff < 5 && sys.moonAlt > -5) engageLock();
        else disengageLock();
      }

      function engageLock() {
        if (sys.isLocked) return;
        sys.isLocked = true;
        if (navigator.vibrate) navigator.vibrate(50);
        // Visual feedback handled by CSS classes on #lock-alert
        const la = $("lock-alert");
        if (la) {
          la.style.opacity = "1";
          la.style.transform = "scale(1)";
        }
        const cu = $("compass-unit");
        if (cu) cu.classList.add("locked");

        const mi = $("moon-icon");
        if (mi) mi.classList.replace("text-gray-300", "text-accent");
        $("target-val").classList.replace("text-gray-500", "text-accent");
        $("azimuth-pill").classList.replace("text-gray-400", "text-accent");
        $("azimuth-pill").classList.replace("border-white/10", "border-accent");
      }

      function disengageLock() {
        if (!sys.isLocked) return;
        sys.isLocked = false;
        const la = $("lock-alert");
        if (la) {
          la.style.opacity = "0";
          la.style.transform = "scale(0.75)";
        }
        const cu = $("compass-unit");
        if (cu) cu.classList.remove("locked");

        const mi = $("moon-icon");
        if (mi) mi.classList.replace("text-accent", "text-gray-300");
        $("target-val").classList.replace("text-accent", "text-gray-500");
        $("azimuth-pill").classList.replace("text-accent", "text-gray-400");
        $("azimuth-pill").classList.replace("border-accent", "border-white/10");
      }

      function updateTelemetry() {
        if (!sys.lat) return;
        const now = new Date();
        const times = SunCalc.getMoonTimes(now, sys.lat, sys.lon);
        const mp = SunCalc.getMoonPosition(now, sys.lat, sys.lon);
        const mi = SunCalc.getMoonIllumination(now);

        sys.moonAz = (mp.azimuth * (180 / Math.PI) + 180) % 360;
        sys.moonAlt = mp.altitude * (180 / Math.PI);
        sys.moonDist = mp.distance;

        const moonDir = getCardinal(sys.moonAz);
        const degTxt = `${Math.round(sys.moonAz)}° ${moonDir}`;
        safeText("target-val", degTxt);
        safeText("azimuth-pill", degTxt);
        safeText("az-grid-val", degTxt);
        safeText("alt-val", `ALT: ${Math.round(sys.moonAlt)}°`);
        safeText("phase-val", Math.round(mi.fraction * 100) + "%");
        safeText("illum-val", Math.round(mi.fraction * 100) + "%");
        safeText("dist-val", (sys.moonDist / 1000).toFixed(1) + "K");
        safeText("cloud-val", sys.clouds + "%");
        safeText("humid-val", sys.humidity + "%");

        const fmt = (d) =>
          d
            ? d.toLocaleTimeString("es-ES", {
                hour: "2-digit",
                minute: "2-digit",
              })
            : "--:--";
        safeText("rise-val", fmt(times.rise));
        safeText("set-val", fmt(times.set));

        let peakAlt = -90;
        let peakTime = null;
        const startDay = new Date(now);
        startDay.setHours(0, 0, 0, 0);
        for (let i = 0; i <= 24 * 4; i++) {
          const t = new Date(startDay.getTime() + i * 15 * 60000);
          const p = SunCalc.getMoonPosition(t, sys.lat, sys.lon);
          if (p.altitude > peakAlt) {
            peakAlt = p.altitude;
            peakTime = t;
          }
        }
        safeText("peak-val", peakTime ? fmt(peakTime) : "N/A");

        // Vis Verdict
        const title = $("vis-verdict");
        const icon = $("vis-icon");
        const bar = $("status-bar");
        if (bar && title && icon) {
          if (sys.moonAlt < 0) {
            title.innerText = "BAJO HORIZONTE";
            title.classList.value =
              "text-2xl font-sans font-bold text-gray-500 leading-none mt-2 tracking-wide";
            icon.classList.value =
              "ph-fill ph-eye-closed text-2xl text-gray-500";
            bar.style.borderLeftColor = "#64748b";
          } else if (sys.clouds > 70) {
            title.innerText = "OBSTRUIDO";
            title.classList.value =
              "text-2xl font-sans font-bold text-warning leading-none mt-2 tracking-wide";
            icon.classList.value =
              "ph-fill ph-cloud-slash text-2xl text-warning";
            bar.style.borderLeftColor = "#f59e0b";
          } else {
            title.innerText = "VISIBILIDAD ÓPTIMA";
            title.classList.value =
              "text-2xl font-sans font-bold text-success leading-none mt-2 tracking-wide shadow-glow-primary";
            icon.classList.value =
              "ph-fill ph-eye text-2xl text-success animate-pulse";
            bar.style.borderLeftColor = "#10b981";
          }
        }

        // Re-draw graph occasionally for "Now" dot
        if (now.getSeconds() % 10 === 0) drawConeGraph(now);
      }

      // --- GRAPH ---
      function drawConeGraph(now) {
        const cvs = $("graph-canvas");
        if (!cvs) return;
        const ctx = cvs.getContext("2d");
        const parent = cvs.parentElement;
        // Handle resizing
        cvs.width = parent.offsetWidth;
        cvs.height = parent.offsetHeight;
        const w = cvs.width;
        const h = cvs.height;

        const start = new Date(now);
        start.setHours(0, 0, 0, 0);

        ctx.clearRect(0, 0, w, h);

        // Horizon
        const horizonY = h * 0.8;
        ctx.beginPath();
        ctx.strokeStyle = "rgba(255,255,255,0.1)";
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.moveTo(0, horizonY);
        ctx.lineTo(w, horizonY);
        ctx.stroke();
        ctx.setLineDash([]);

        // Gradient
        const grad = ctx.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, "rgba(56, 189, 248, 0.2)");
        grad.addColorStop(1, "rgba(0, 0, 0, 0)");

        let points = [];
        const pxPerDeg = (horizonY - 20) / 90; // Scale 90deg to fit above horizon

        ctx.beginPath();
        let first = true;
        for (let i = 0; i <= 24; i += 0.5) {
          const t = new Date(start.getTime() + i * 3600000);
          const pos = SunCalc.getMoonPosition(t, sys.lat, sys.lon);
          // Simple Y mapping
          const y = horizonY - pos.altitude * (180 / Math.PI) * pxPerDeg;
          const x = (i / 24) * w;

          points.push({ x, y });
          if (first) {
            ctx.moveTo(x, y);
            first = false;
          } else {
            ctx.lineTo(x, y);
          }
        }

        ctx.lineTo(w, h);
        ctx.lineTo(0, h);
        ctx.closePath();
        ctx.fillStyle = grad;
        ctx.fill();

        // Line
        ctx.beginPath();
        first = true;
        for (let p of points) {
          if (first) {
            ctx.moveTo(p.x, p.y);
            first = false;
          } else {
            ctx.lineTo(p.x, p.y);
          }
        }
        ctx.strokeStyle = "#38bdf8";
        ctx.lineWidth = 3;
        ctx.stroke(); // Thicker line

        // Now Dot
        const currHours = now.getHours() + now.getMinutes() / 60;
        const currPos = SunCalc.getMoonPosition(now, sys.lat, sys.lon);
        const nowY = horizonY - currPos.altitude * (180 / Math.PI) * pxPerDeg;
        const nowX = (currHours / 24) * w;

        if (nowX >= 0 && nowX <= w) {
          const isVisible = currPos.altitude > 0;
          // Line down
          ctx.beginPath();
          ctx.strokeStyle = "rgba(255,255,255,0.3)";
          ctx.lineWidth = 1;
          ctx.moveTo(nowX, nowY);
          ctx.lineTo(nowX, horizonY);
          ctx.stroke();
          // Dot
          ctx.beginPath();
          ctx.arc(nowX, nowY, 6, 0, Math.PI * 2);
          ctx.fillStyle = isVisible ? "#d946ef" : "#64748b"; // Accent color for current time
          ctx.shadowBlur = 10;
          ctx.shadowColor = isVisible ? "#d946ef" : "transparent";
          ctx.fill();
          ctx.shadowBlur = 0;
        }
      }

      const futBtn = $("future-btn");
      if (futBtn)
        futBtn.addEventListener("click", () => {
          const p = $("future-panel");
          if (p) p.classList.toggle("hidden");
        });
      const closeFut = $("close-future");
      if (closeFut)
        closeFut.addEventListener("click", () => {
          const p = $("future-panel");
          if (p) p.classList.add("hidden");
        });

      const fCalc = $("f-calc");
      if (fCalc) {
        fCalc.addEventListener("click", async () => {
          const val = $("f-input").value;
          if (!val) return;
          const t = new Date(val);
          const res = $("f-result");
          res.classList.remove("hidden");
          res.innerHTML =
            "<span class='text-primary animate-pulse'>PROCESANDO DATOS ORBITALES...</span>";
          const mp = SunCalc.getMoonPosition(t, sys.lat, sys.lon);
          const alt = Math.round(mp.altitude * (180 / Math.PI));
          let c = "--";
          try {
            const iso = val.split("T")[0];
            const r = await fetch(
              `https://api.open-meteo.com/v1/forecast?latitude=${sys.lat}&longitude=${sys.lon}&hourly=cloud_cover&start_date=${iso}&end_date=${iso}&timezone=auto`,
            );
            const d = await r.json();
            c = d.hourly.cloud_cover[t.getHours()] || "--";
          } catch (e) {}
          let status =
            alt > 0 ? (c < 50 ? "VIABLE" : "OBSTRUIDO") : "BAJO HORIZONTE";
          let color =
            alt > 0
              ? c < 50
                ? "text-success"
                : "text-warning"
              : "text-danger";
          res.innerHTML = `<div class="grid grid-cols-2 gap-2 mt-4 bg-black/40 p-3 rounded-lg border border-white/5"><div><span class="label-tech block">ELEVACIÓN</span><b class="text-white text-lg">${alt}°</b></div><div><span class="label-tech block">COBERTURA</span><b class="text-white text-lg">${c}%</b></div></div><div class="${color} font-bold font-mono text-center mt-3 border border-current rounded py-2 text-sm tracking-widest bg-white/5">${status}</div>`;
        });
      }

      // --- VIEW SWITCHING ---
      function switchView(viewId, btn) {
        document.querySelectorAll(".nav-item").forEach((el) => {
          el.classList.remove("active");
          if (el.classList.contains("text-gray-500") === false)
            el.classList.add("text-gray-500");
        });
        if (btn) {
          btn.classList.add("active");
          btn.classList.remove("text-gray-500");
        }

        document
          .querySelectorAll(".view-section")
          .forEach((el) => el.classList.add("hidden"));
        const v = $(viewId);
        if (v) v.classList.remove("hidden");

        if (viewId === "view-ar") startAR();
        else stopAR();
      }

      function startAR() {
        const v = $("ar-video");
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({ video: { facingMode: "environment" } })
            .then((s) => {
              v.srcObject = s;
              v.play();
            });
        }
      }
      function stopAR() {
        const v = $("ar-video");
        if (v.srcObject) v.srcObject.getTracks().forEach((t) => t.stop());
      }

      // Paywall Logic
      window.openPaywall = () => {
        $("paywall-modal").classList.remove("hidden");
        setTimeout(() => {
          $("paywall-modal").classList.remove("opacity-0");
          const content = $("paywall-content");
          content.classList.remove("scale-95");
          content.classList.add("scale-100");
        }, 10);
      };
      window.closePaywall = () => {
        const content = $("paywall-content");
        content.classList.remove("scale-100");
        content.classList.add("scale-95");
        $("paywall-modal").classList.add("opacity-0");
        setTimeout(() => $("paywall-modal").classList.add("hidden"), 300);
      };
      window.processPayment = () => {
        const b = $("pay-btn");
        b.innerText = "VERIFICANDO BIOMETRÍA...";
        setTimeout(() => {
          b.innerText = "SUSCRIPCIÓN ACTIVA";
          b.className =
            "w-full bg-success text-white font-bold py-4 rounded-xl shadow-glow-primary tracking-widest text-sm font-mono";
          setTimeout(closePaywall, 1000);
          sys.isPro = true;
        }, 1500);
      };
    </script>
  </body>
</html>
