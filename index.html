<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <!-- PWA Manifest Simulation -->
    <link
      rel="manifest"
      href="data:application/json;base64,eyJuYW1lIjoiTHVtaW5hIFBybyIsInNob3J0X25hbWUiOiJMdW1pbmEiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzA1MDUwNSIsInRoZW1lX2NvbG9yIjoiIzM4YmRmOCIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2ltZy5pY29uczhjb20vY29sb3IvOTYvMDAwMDAwL21vb24tc2F0ZWxsaXRlLnBuZyIsInNpemVzIjoiOTZ4OTYiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ=="
    />
    <meta name="theme-color" content="#050505" />

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              void: "#050505",
              primary: "#38bdf8",
              accent: "#d946ef",
              gold: "#fbbf24",
              success: "#10b981",
              warning: "#f59e0b",
              danger: "#f43f5e",
              panel: "rgba(10, 10, 16, 0.85)",
            },
            fontFamily: {
              mono: ['"Orbitron"', "sans-serif"],
              sans: ['"Rajdhani"', "sans-serif"],
            },
            boxShadow: {
              "glow-primary": "0 0 15px rgba(56, 189, 248, 0.3)",
              "glow-accent": "0 0 20px rgba(217, 70, 239, 0.4)",
            },
            backgroundImage: {
              "tech-grid":
                "linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px)",
            },
            animation: {
              "spin-slow": "spin 120s linear infinite",
            },
          },
        },
      };
    </script>

    <style>
      body {
        background-color: #050505;
        color: #e2e8f0;
        overflow: hidden;
        touch-action: none;
        font-family: "Rajdhani", sans-serif;
      }

      .hud-module {
        background: var(--panel);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .hud-module::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
      }

      .label-tech {
        font-weight: 700;
        font-size: 0.65rem;
        letter-spacing: 0.15em;
        color: #64748b;
        text-transform: uppercase;
      }
      .value-tech {
        font-family: "Orbitron", sans-serif;
        letter-spacing: 0.05em;
      }

      /* Compass */
      .compass-lens {
        border-radius: 50%;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(255, 255, 255, 0.01) 0%,
          rgba(0, 0, 0, 0.6) 80%
        );
        box-shadow:
          0 0 0 1px rgba(255, 255, 255, 0.1),
          inset 0 0 40px rgba(0, 0, 0, 0.8);
        position: relative;
      }
      .dial-ring {
        transition: transform 0.1s linear;
        will-change: transform;
      }
      .smooth-move {
        transition: transform 0.3s ease-out;
      }
      .tick-mark {
        position: absolute;
        left: 50%;
        transform-origin: bottom center;
        background: rgba(255, 255, 255, 0.5);
      }
      .tick-major {
        height: 8px;
        width: 2px;
        background: #38bdf8;
        box-shadow: 0 0 5px #38bdf8;
      }
      .tick-minor {
        height: 4px;
        width: 1px;
        opacity: 0.4;
      }
      .locked .compass-lens {
        border-color: #d946ef;
        box-shadow:
          inset 0 0 30px rgba(217, 70, 239, 0.2),
          0 0 20px rgba(217, 70, 239, 0.3);
      }
      .locked .center-reticle {
        background: #d946ef;
        box-shadow: 0 0 15px #d946ef;
      }

      /* Navigation */
      .nav-dock {
        background: rgba(5, 5, 5, 0.95);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        padding-bottom: env(safe-area-inset-bottom);
      }
      .nav-item {
        color: #64748b;
        transition: all 0.3s ease;
        position: relative;
      }
      .nav-item.active {
        color: #38bdf8;
      }

      /* AR Overlay */
      #ar-video {
        object-fit: cover;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 0;
      }
      .ar-hud-corner {
        position: absolute;
        width: 40px;
        height: 40px;
        border-color: rgba(56, 189, 248, 0.6);
        pointer-events: none;
      }

      canvas {
        image-rendering: pixelated;
      }
      ::-webkit-scrollbar {
        width: 0px;
      }
    </style>
  </head>
  <body
    class="bg-void h-screen w-screen flex flex-col relative selection:bg-accent selection:text-white"
  >
    <div
      class="absolute inset-0 bg-tech-grid bg-[length:30px_30px] opacity-10 pointer-events-none"
    ></div>

    <!-- BOOT SEQUENCE -->
    <div
      id="boot-sequence"
      class="fixed inset-0 z-[100] bg-void flex flex-col items-center justify-center p-8 transition-opacity duration-700"
    >
      <div class="relative w-48 h-48 flex items-center justify-center mb-10">
        <div
          class="absolute inset-0 border border-primary/20 rounded-full animate-[spin_10s_linear_infinite]"
        ></div>
        <div
          class="absolute inset-4 border border-t-primary border-r-transparent border-b-transparent border-l-transparent rounded-full animate-[spin_3s_linear_infinite]"
        ></div>
        <div
          class="absolute inset-8 border border-b-accent border-t-transparent border-l-transparent border-r-transparent rounded-full animate-[spin_2s_linear_infinite_reverse]"
        ></div>
        <div class="relative z-10 flex flex-col items-center animate-pulse">
          <i
            class="ph-duotone ph-planet text-6xl text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]"
          ></i>
        </div>
      </div>
      <h1
        class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-white to-purple-500 font-mono tracking-tighter mb-2"
      >
        LUMINA
      </h1>
      <button
        id="system-start-btn"
        class="group relative px-10 py-4 overflow-hidden bg-transparent border border-white/20 hover:border-purple-500/50 transition-all duration-500"
      >
        <span
          class="relative text-sm font-mono font-bold text-white group-hover:text-purple-400 transition-colors tracking-widest flex items-center gap-3"
          >INICIAR SISTEMA <i class="ph-bold ph-caret-right"></i
        ></span>
      </button>
    </div>

    <!-- MAIN APP -->
    <div
      id="main-app"
      class="flex-1 flex flex-col h-full opacity-0 transition-opacity duration-1000 relative overflow-hidden"
    >
      <!-- GLOBAL HEADER -->
      <header
        class="flex justify-between items-start px-5 pt-5 z-20 mb-2 absolute w-full top-0 pointer-events-none"
      >
        <div class="pointer-events-auto">
          <div class="flex items-center gap-2 mb-0.5">
            <span class="relative flex h-2 w-2"
              ><span
                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-500 opacity-75"
              ></span
              ><span
                class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"
              ></span
            ></span>
            <span
              id="user-tier"
              class="text-[10px] font-mono font-bold text-emerald-500 tracking-widest"
              >GRATUITO</span
            >
          </div>
          <div class="text-[9px] font-mono text-gray-500" id="gps-coords">
            GPS: BUSCANDO...
          </div>
        </div>
        <div class="text-right pointer-events-auto">
          <button
            id="upgrade-btn"
            class="mb-1 bg-gradient-to-r from-amber-500 to-yellow-600 text-black text-[10px] font-bold px-3 py-1 rounded-full shadow-[0_0_15px_rgba(251,191,36,0.4)] animate-pulse hover:scale-105 transition-transform"
          >
            <i class="ph-fill ph-crown"></i> PRO
          </button>
          <div
            id="clock"
            class="text-xl font-mono font-bold text-white leading-none"
          >
            00:00
          </div>
          <div
            id="date"
            class="text-[10px] font-sans font-bold text-cyan-400 tracking-widest mt-0.5"
          >
            -- ---
          </div>
        </div>
      </header>

      <!-- VIEWS -->
      <div
        class="flex-1 relative overflow-y-auto pb-20 pt-16 scroll-smooth"
        id="views-container"
      >
        <!-- [VIEW 1] COMMAND CENTER -->
        <section id="view-home" class="view-section flex flex-col min-h-full">
          <!-- COMPASS -->
          <div
            class="flex-shrink-0 relative flex flex-col items-center justify-center py-2 min-h-[260px]"
          >
            <div
              class="absolute w-[240px] h-[240px] border border-white/5 rounded-full pointer-events-none"
            ></div>
            <div
              class="absolute w-[260px] h-[260px] border border-dashed border-white/5 rounded-full pointer-events-none animate-[spin_60s_linear_infinite]"
            ></div>
            <div
              class="relative w-64 h-64 flex items-center justify-center compass-lens transition-all duration-300"
              id="compass-unit"
            >
              <div
                class="absolute top-0 z-50 w-1 h-5 bg-cyan-400 rounded-full shadow-[0_0_15px_#38bdf8]"
              ></div>
              <div
                id="compass-dial"
                class="dial-ring w-full h-full rounded-full relative"
              >
                <div
                  id="ticks-layer"
                  class="w-full h-full absolute inset-0 opacity-70"
                ></div>
                <div class="absolute inset-0 z-30 pointer-events-none">
                  <span
                    class="absolute top-3 left-1/2 -translate-x-1/2 text-lg font-mono font-black text-white"
                    >N</span
                  >
                  <span
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-mono font-bold text-gray-600"
                    >E</span
                  >
                  <span
                    class="absolute bottom-3 left-1/2 -translate-x-1/2 text-xs font-mono font-bold text-gray-600"
                    >S</span
                  >
                  <span
                    class="absolute left-3 top-1/2 -translate-y-1/2 text-xs font-mono font-bold text-gray-600"
                    >O</span
                  >
                </div>
                <!-- Moon Pointer: rotated independently or within the dial -->
                <div
                  id="moon-pointer"
                  class="absolute inset-0 z-20 smooth-move"
                >
                  <div
                    class="absolute top-8 left-1/2 -translate-x-1/2 flex flex-col items-center"
                  >
                    <i
                      id="moon-icon"
                      class="ph-fill ph-moon-stars text-3xl text-gray-400 drop-shadow-md"
                    ></i>
                    <div
                      id="azimuth-pill"
                      class="mt-1 bg-black/60 px-1.5 rounded text-[8px] font-mono text-gray-400 border border-white/10"
                    >
                      ---
                    </div>
                  </div>
                </div>
              </div>
              <div
                id="lock-alert"
                class="absolute inset-0 flex items-center justify-center opacity-0 scale-75 transition-all duration-300 pointer-events-none"
              >
                <div
                  class="bg-black/90 border border-purple-500 text-purple-500 px-3 py-1 rounded text-[10px] font-mono font-bold tracking-[0.2em] shadow-[0_0_20px_#d946ef] animate-pulse"
                >
                  LOCKED
                </div>
              </div>
            </div>
            <div
              class="absolute bottom-0 w-full flex justify-between px-8 pointer-events-none"
            >
              <div class="text-left">
                <div class="label-tech text-cyan-400">RUMBO</div>
                <div
                  id="heading-val"
                  class="text-xl font-mono font-bold text-white"
                >
                  000°
                </div>
              </div>
              <div class="text-right">
                <div class="label-tech text-purple-500">OBJETIVO</div>
                <div
                  id="target-val"
                  class="text-xl font-mono font-bold text-gray-400"
                >
                  ---°
                </div>
              </div>
            </div>
          </div>

          <!-- DASHBOARD -->
          <div class="px-4 mt-2 space-y-3">
            <div
              class="hud-module p-3 flex items-center justify-between border-l-4 border-gray-600 transition-colors duration-500"
              id="status-bar"
            >
              <div class="flex flex-col">
                <span class="label-tech">ESTADO VISUAL</span>
                <div
                  id="vis-verdict"
                  class="text-xl font-sans font-bold text-white leading-none mt-1"
                >
                  ANALIZANDO...
                </div>
              </div>
              <div class="text-right">
                <div
                  id="vis-icon-container"
                  class="bg-white/5 p-2 rounded-lg border border-white/5"
                >
                  <i
                    id="vis-icon"
                    class="ph-fill ph-broadcast text-xl text-gray-500"
                  ></i>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div class="hud-module p-3 flex flex-col gap-2">
                <div
                  class="flex justify-between items-center border-b border-white/5 pb-1"
                >
                  <span class="label-tech text-purple-500"
                    ><i class="ph-bold ph-planet"></i> LUNA</span
                  ><span id="phase-val" class="text-[10px] font-mono text-white"
                    >--%</span
                  >
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <span class="label-tech block">ILUM</span
                    ><span
                      id="illum-val"
                      class="value-tech text-sm font-bold text-white"
                      >--%</span
                    >
                  </div>
                  <div class="text-right">
                    <span class="label-tech block">DIST</span
                    ><span
                      id="dist-val"
                      class="value-tech text-sm font-bold text-cyan-400"
                      >--K</span
                    >
                  </div>
                </div>
              </div>
              <div class="hud-module p-3 flex flex-col gap-2">
                <div
                  class="flex justify-between items-center border-b border-white/5 pb-1"
                >
                  <span class="label-tech text-cyan-400"
                    ><i class="ph-bold ph-crosshair"></i> POSICIÓN</span
                  ><span id="alt-val" class="text-[10px] font-mono text-white"
                    >ALT: --°</span
                  >
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <div>
                    <span class="label-tech block">PICO</span
                    ><span
                      id="peak-val"
                      class="value-tech text-sm font-bold text-yellow-500"
                      >--:--</span
                    >
                  </div>
                  <div class="text-right">
                    <span class="label-tech block">AZIMUT</span
                    ><span
                      id="az-grid-val"
                      class="value-tech text-sm font-bold text-white"
                      >--</span
                    >
                  </div>
                </div>
              </div>
              <div class="hud-module p-3">
                <span class="label-tech block mb-1">CICLO DIARIO</span>
                <div
                  class="flex justify-between items-center bg-black/20 rounded p-1.5 border border-white/5"
                >
                  <div class="text-center">
                    <i class="ph-bold ph-arrow-up text-cyan-400 text-xs"></i>
                    <div
                      id="rise-val"
                      class="text-xs font-mono font-bold text-white"
                    >
                      --:--
                    </div>
                  </div>
                  <div class="h-6 w-[1px] bg-white/10"></div>
                  <div class="text-center">
                    <i
                      class="ph-bold ph-arrow-down text-purple-500 text-xs"
                    ></i>
                    <div
                      id="set-val"
                      class="text-xs font-mono font-bold text-white"
                    >
                      --:--
                    </div>
                  </div>
                </div>
              </div>
              <div class="hud-module p-3">
                <span class="label-tech block mb-1">ATMÓSFERA</span>
                <div class="grid grid-cols-2 gap-2">
                  <div class="flex flex-col">
                    <span class="text-[9px] text-gray-500 font-mono">NUBES</span
                    ><span
                      id="cloud-val"
                      class="text-sm font-mono font-bold text-white"
                      >--%</span
                    >
                  </div>
                  <div class="flex flex-col text-right">
                    <span class="text-[9px] text-gray-500 font-mono">HUM</span
                    ><span
                      id="humid-val"
                      class="text-sm font-mono font-bold text-cyan-400"
                      >--%</span
                    >
                  </div>
                </div>
              </div>
            </div>

            <div
              class="hud-module p-0 relative h-40 flex items-center justify-center"
            >
              <div class="absolute top-3 left-4 z-10">
                <span class="label-tech text-purple-500 block tracking-widest"
                  >TRAYECTORIA PICO</span
                >
              </div>
              <canvas
                id="graph-canvas"
                class="w-full h-full absolute inset-0"
              ></canvas>
              <button
                id="future-btn"
                class="absolute top-3 right-4 bg-white/5 hover:bg-purple-500 hover:text-white border border-white/10 text-gray-400 px-2 py-1 rounded text-[9px] font-mono font-bold transition-colors z-10"
              >
                SIMULAR
              </button>
            </div>

            <div
              id="future-panel"
              class="hidden hud-module p-4 border-t border-purple-500 animate-[fadeIn_0.3s_ease]"
            >
              <div class="flex justify-between items-center mb-3">
                <span class="label-tech text-purple-500">SIMULADOR</span
                ><button
                  id="close-future"
                  class="text-gray-400 hover:text-white"
                >
                  <i class="ph-bold ph-x"></i>
                </button>
              </div>
              <div class="flex gap-2 mb-3">
                <input
                  type="datetime-local"
                  id="f-input"
                  class="w-full bg-black/40 border border-white/20 rounded px-3 py-2 text-xs text-white font-mono outline-none focus:border-purple-500"
                />
              </div>
              <button
                id="f-calc"
                class="w-full bg-purple-500/20 border border-purple-500/50 text-purple-500 hover:bg-purple-500 hover:text-white py-2 rounded font-mono font-bold text-xs transition-colors"
              >
                CALCULAR
              </button>
              <div id="f-result" class="mt-3 text-center hidden"></div>
            </div>
          </div>
        </section>

        <!-- [VIEW 2] AR (HUD MEJORADO) -->
        <section
          id="view-ar"
          class="view-section hidden h-full relative bg-black"
        >
          <div
            id="ar-container"
            class="absolute inset-0 flex flex-col items-center justify-center overflow-hidden"
          >
            <video
              id="ar-video"
              playsinline
              autoplay
              muted
              class="opacity-70"
            ></video>

            <!-- HUD OVERLAY -->
            <div class="absolute inset-0 z-10 pointer-events-none">
              <!-- Esquinas -->
              <div
                class="absolute top-8 left-8 w-16 h-16 border-t-2 border-l-2 border-cyan-500/50 rounded-tl-xl"
              ></div>
              <div
                class="absolute top-8 right-8 w-16 h-16 border-t-2 border-r-2 border-cyan-500/50 rounded-tr-xl"
              ></div>
              <div
                class="absolute bottom-24 left-8 w-16 h-16 border-b-2 border-l-2 border-cyan-500/50 rounded-bl-xl"
              ></div>
              <div
                class="absolute bottom-24 right-8 w-16 h-16 border-b-2 border-r-2 border-cyan-500/50 rounded-br-xl"
              ></div>

              <!-- Reticula Central -->
              <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 border border-white/10 rounded-full flex items-center justify-center"
              >
                <div class="w-1 h-4 bg-cyan-500 absolute top-0"></div>
                <div class="w-1 h-4 bg-cyan-500 absolute bottom-0"></div>
                <div class="w-4 h-1 bg-cyan-500 absolute left-0"></div>
                <div class="w-4 h-1 bg-cyan-500 absolute right-0"></div>
                <div
                  class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"
                ></div>
              </div>

              <!-- Datos Flotantes -->
              <div
                class="absolute top-10 left-1/2 -translate-x-1/2 bg-black/60 px-4 py-1 rounded-full border border-white/10"
              >
                <span class="text-xs font-mono text-cyan-400" id="ar-heading"
                  >RUMBO: ---°</span
                >
              </div>
            </div>

            <div
              class="absolute bottom-24 bg-black/80 px-6 py-2 rounded-xl border-l-4 border-purple-500 text-center backdrop-blur-md z-20"
            >
              <span class="label-tech text-white block">SISTEMA AR ACTIVO</span>
              <div class="text-xs text-gray-400 font-mono">
                APUNTE AL CIELO PARA LOCALIZAR
              </div>
            </div>
          </div>
        </section>

        <!-- [VIEW 3] MAP (PRO) -->
        <section
          id="view-map"
          class="view-section hidden h-full relative p-4 flex flex-col gap-4"
        >
          <h2
            class="text-xl font-bold font-mono text-yellow-500 mb-2 flex items-center gap-2"
          >
            <i class="ph-fill ph-map-trifold"></i> MAPA DE OSCURIDAD
            <span class="bg-yellow-500 text-black text-[10px] px-1 rounded"
              >PRO</span
            >
          </h2>
          <div
            class="hud-module h-96 relative flex items-center justify-center overflow-hidden group border-yellow-500/30"
          >
            <div
              class="absolute inset-0 bg-[url('https://upload.wikimedia.org/wikipedia/commons/8/86/Earth_lights_vs_population_density.png')] bg-cover bg-center opacity-30 grayscale group-hover:grayscale-0 transition-all duration-700"
            ></div>
            <div
              class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center text-center p-6 backdrop-blur-sm"
              id="map-lock-overlay"
            >
              <i class="ph-fill ph-lock-key text-4xl text-yellow-500 mb-2"></i>
              <h3 class="text-lg font-bold text-white mb-1">
                FUNCIÓN BLOQUEADA
              </h3>
              <button
                onclick="openPaywall()"
                class="bg-yellow-500 text-black font-bold px-6 py-2 rounded-full hover:scale-105 transition-transform shadow-[0_0_15px_#fbbf24] mt-2"
              >
                DESBLOQUEAR
              </button>
            </div>
            <div
              id="map-unlocked"
              class="hidden absolute inset-0 bg-black flex flex-col"
            >
              <div
                class="bg-gray-800 h-full w-full flex items-center justify-center text-gray-500 font-mono"
              >
                [MAPA INTERACTIVO CARGADO]
              </div>
            </div>
          </div>
        </section>

        <!-- [VIEW 4] TOOLS -->
        <section
          id="view-tools"
          class="view-section hidden h-full p-4 pb-20 overflow-y-auto"
        >
          <h2
            class="text-xl font-bold font-mono text-white mb-4 flex items-center gap-2"
          >
            <i class="ph-fill ph-toolbox"></i> EQUIPAMIENTO
          </h2>
          <!-- Photo Kit -->
          <div
            class="hud-module p-4 mb-4 border-l-4 border-yellow-500 bg-gradient-to-r from-yellow-500/5 to-transparent"
          >
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-sm font-bold text-yellow-500">
                KIT FOTÓGRAFO PRO
              </h3>
              <i class="ph-fill ph-camera text-yellow-500"></i>
            </div>
            <div class="relative">
              <div
                class="grid grid-cols-2 gap-3 blur-sm select-none"
                id="photo-kit-blur"
              >
                <div class="bg-black/40 p-2 rounded">
                  <span class="label-tech">ISO</span>
                  <div class="text-white font-mono">100</div>
                </div>
                <div class="bg-black/40 p-2 rounded">
                  <span class="label-tech">OBTURADOR</span>
                  <div class="text-white font-mono">1/125</div>
                </div>
              </div>
              <div
                class="absolute inset-0 flex items-center justify-center"
                id="photo-lock-btn"
              >
                <button
                  onclick="openPaywall()"
                  class="bg-yellow-500 text-black text-xs font-bold px-4 py-2 rounded-full shadow-[0_0_10px_#fbbf24] flex items-center gap-2"
                >
                  <i class="ph-bold ph-lock-key"></i> DESBLOQUEAR
                </button>
              </div>
            </div>
          </div>
          <!-- Affiliates -->
          <h3
            class="label-tech text-white mb-3 mt-6 border-b border-white/10 pb-1"
          >
            RECOMENDADO
          </h3>
          <div class="grid grid-cols-1 gap-4">
            <div
              class="hud-module p-3 flex gap-4 items-center group cursor-pointer hover:border-cyan-500/50 transition-colors"
            >
              <div
                class="w-16 h-16 bg-white/10 rounded flex items-center justify-center"
              >
                <i
                  class="ph-duotone ph-telescope text-3xl text-gray-400 group-hover:text-cyan-400"
                ></i>
              </div>
              <div class="flex-1">
                <h4
                  class="font-bold text-sm text-white group-hover:text-cyan-400"
                >
                  Celestron AstroMaster
                </h4>
                <span class="text-xs font-mono text-yellow-500 mt-2 block"
                  >$149.99</span
                >
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- NAV -->
      <nav
        class="nav-dock fixed bottom-0 w-full flex justify-around items-center px-2 py-3 z-40"
      >
        <button
          class="nav-item active flex flex-col items-center gap-1 w-16"
          onclick="switchView('view-home', this)"
        >
          <i class="ph-fill ph-crosshair text-xl"></i
          ><span class="text-[9px] font-bold tracking-widest">CMD</span>
        </button>
        <button
          class="nav-item flex flex-col items-center gap-1 w-16 text-gray-500"
          onclick="switchView('view-ar', this)"
        >
          <i class="ph-fill ph-camera text-xl"></i
          ><span class="text-[9px] font-bold tracking-widest">AR</span>
        </button>
        <button
          class="nav-item flex flex-col items-center gap-1 w-16 text-gray-500"
          onclick="switchView('view-map', this)"
        >
          <i class="ph-fill ph-map-trifold text-xl"></i
          ><span class="text-[9px] font-bold tracking-widest">MAPA</span>
        </button>
        <button
          class="nav-item flex flex-col items-center gap-1 w-16 text-gray-500"
          onclick="switchView('view-tools', this)"
        >
          <i class="ph-fill ph-toolbox text-xl"></i
          ><span class="text-[9px] font-bold tracking-widest">KIT</span>
        </button>
      </nav>
    </div>

    <!-- PAYWALL -->
    <div
      id="paywall-modal"
      class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-xl flex items-center justify-center p-6 hidden opacity-0 transition-opacity duration-300"
    >
      <div
        class="bg-gray-900 border border-yellow-500 rounded-2xl p-6 max-w-sm w-full relative shadow-[0_0_30px_#fbbf24]"
      >
        <button
          onclick="closePaywall()"
          class="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <i class="ph-bold ph-x text-xl"></i>
        </button>
        <div class="text-center mb-6">
          <i class="ph-fill ph-crown text-4xl text-yellow-500 mb-2"></i>
          <h2 class="text-2xl font-bold text-white font-mono">
            LUMINA <span class="text-yellow-500">PRO</span>
          </h2>
          <p class="text-gray-400 text-xs mt-2">
            Desbloquea el poder del cosmos.
          </p>
        </div>
        <button
          onclick="processPayment()"
          class="w-full bg-gradient-to-r from-yellow-500 to-amber-600 text-black font-bold py-3 rounded-xl hover:scale-105 transition-transform shadow-lg mb-3"
          id="pay-btn"
        >
          SUSCRIBIRSE - $2.99
        </button>
      </div>
    </div>

    <!-- TOAST -->
    <div
      id="toast"
      class="fixed top-4 left-1/2 -translate-x-1/2 bg-white/10 backdrop-blur border border-white/20 px-4 py-2 rounded-full text-xs font-bold text-white shadow-lg pointer-events-none transform -translate-y-20 transition-transform duration-500 z-[300]"
    ></div>

    <script>
      // --- UTILS ---
      const $ = (id) => document.getElementById(id);
      const safeText = (id, txt) => {
        const el = $(id);
        if (el) el.innerText = txt;
      };

      // --- HELPER: CARDINAL DIRECTION ---
      function getCardinal(angle) {
        const directions = [
          "N",
          "NNE",
          "NE",
          "ENE",
          "E",
          "ESE",
          "SE",
          "SSE",
          "S",
          "SSO",
          "SO",
          "OSO",
          "O",
          "ONO",
          "NO",
          "NNO",
        ];
        // Normalize angle
        const normalized = ((angle % 360) + 360) % 360;
        const index = Math.round(normalized / 22.5) % 16;
        return directions[index];
      }

      // --- STATE ---
      const sys = {
        lat: null,
        lon: null,
        heading: 0,
        accumHeading: 0,
        lastRawHeading: 0,
        moonAz: 0,
        moonAlt: 0,
        moonDist: 0,
        isLocked: false,
        clouds: 0,
        humidity: 0,
        isPro: false,
      };

      // --- TICKS ---
      const ticksLayer = $("ticks-layer");
      if (ticksLayer) {
        for (let i = 0; i < 360; i += 2) {
          if (i % 90 === 0) continue;
          const el = document.createElement("div");
          el.className = `tick-mark ${i % 10 === 0 ? "tick-major" : "tick-minor"}`;
          el.style.top = "6px";
          el.style.left = "50%";
          el.style.top = "50%";
          el.style.transform = `translate(-50%, -50%) rotate(${i}deg) translateY(-110px)`;
          ticksLayer.appendChild(el);
        }
      }

      // --- INIT ---
      $("system-start-btn").addEventListener("click", async () => {
        if (
          typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function"
        ) {
          try {
            await DeviceOrientationEvent.requestPermission();
          } catch (e) {}
        }
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(handleGPS, null, {
            enableHighAccuracy: true,
          });
        }

        // Modern event listener logic
        if ("ondeviceorientationabsolute" in window) {
          window.addEventListener(
            "deviceorientationabsolute",
            handleOrientation,
          );
        } else {
          window.addEventListener("deviceorientation", handleOrientation);
        }

        $("boot-sequence").style.opacity = "0";
        setTimeout(() => {
          $("boot-sequence").style.display = "none";
          $("main-app").style.opacity = "1";
          startLoops();
        }, 800);
      });

      function startLoops() {
        setInterval(() => {
          const now = new Date();
          safeText("clock", now.toLocaleTimeString("es-ES", { hour12: false }));
          safeText(
            "date",
            now
              .toLocaleDateString("es-ES", {
                day: "2-digit",
                month: "short",
                year: "numeric",
              })
              .toUpperCase()
              .replace(".", ""),
          );
        }, 1000);

        setInterval(() => {
          if (sys.lat) updateTelemetry();
        }, 1000); // 1s is enough

        const now = new Date();
        const pad = (n) => n.toString().padStart(2, "0");
        const fi = $("f-input");
        if (fi)
          fi.value = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;

        // Initial render
        drawConeGraph(now);
      }

      function handleGPS(pos) {
        sys.lat = pos.coords.latitude;
        sys.lon = pos.coords.longitude;
        safeText(
          "gps-coords",
          `GPS: ${sys.lat.toFixed(4)}, ${sys.lon.toFixed(4)}`,
        );
        fetchWeather();
        drawConeGraph(new Date());
        updateTelemetry();
      }

      async function fetchWeather() {
        if (!sys.lat) return;
        try {
          const r = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${sys.lat}&longitude=${sys.lon}&current=cloud_cover,relative_humidity_2m&timezone=auto`,
          );
          const d = await r.json();
          sys.clouds = d.current.cloud_cover;
          sys.humidity = d.current.relative_humidity_2m;
        } catch (e) {}
      }

      function handleOrientation(e) {
        let alpha = e.alpha;
        // Handle iOS vs Android differences
        if (e.webkitCompassHeading) {
          // iOS: webkitCompassHeading is already "Degree from North"
          alpha = e.webkitCompassHeading;
        } else {
          // Android: alpha is usually "Degree from North" but inverted or offset
          // deviceorientationabsolute is best, but standard fallback:
          alpha = 360 - alpha;
        }

        if (alpha === null || isNaN(alpha)) return;

        // Screen Orientation Correction (Landscape/Portrait)
        // let screenAngle = window.screen.orientation ? window.screen.orientation.angle : 0;
        // Actually, for compass UI, we often just want the heading.
        // If the user rotates the phone to landscape, the heading value might need adjustment relative to the "top" of the phone.
        // But usually browsers handle this via the event or we just use phone's top.
        // We will stick to raw heading but ensure 0-360 range.

        let heading = alpha;

        // Smoothing filter
        let delta = heading - sys.lastRawHeading;
        if (delta < -180) delta += 360;
        else if (delta > 180) delta -= 360;

        sys.accumHeading += delta;
        sys.lastRawHeading = heading;
        sys.heading = heading;

        // Normalized heading for display
        let displayHeading = ((heading % 360) + 360) % 360;

        safeText("heading-val", `${Math.round(displayHeading)}°`);
        safeText(
          "ar-heading",
          `RUMBO: ${Math.round(displayHeading)}° ${getCardinal(displayHeading)}`,
        );

        // Rotate the Dial
        // The dial ticks should rotate counter to the heading so "North" always points to real North
        const cd = $("compass-dial");
        if (cd) cd.style.transform = `rotate(${-displayHeading}deg)`;

        // Rotate the Moon Pointer
        // The pointer is inside the dial.
        // The dial is already rotated by -Heading.
        // If we rotate the pointer by Azimuth, it will point to (Azimuth - Heading) visually relative to the phone top?
        // Wait:
        // Container (0deg) -> Dial (-H deg).
        // If we put Pointer inside Dial and rotate Pointer by (A deg),
        // Total transform = -H + A = A - H.
        // If Moon is at 90 (East) and Heading is 0 (North), Result = 90 (Right). Correct.
        // If Moon is at 90 (East) and Heading is 90 (East), Result = 0 (Top). Correct.
        // So we just rotate by Azimuth.

        const mp = $("moon-pointer");
        if (mp) mp.style.transform = `rotate(${sys.moonAz}deg)`;

        // Lock Logic
        let diff = Math.abs(displayHeading - sys.moonAz);
        if (diff > 180) diff = 360 - diff;

        if (diff < 5 && sys.moonAlt > -5) engageLock();
        else disengageLock();
      }

      function engageLock() {
        if (sys.isLocked) return;
        sys.isLocked = true;
        if (navigator.vibrate) navigator.vibrate(50);
        const cu = $("compass-unit");
        if (cu) cu.classList.add("locked");
        const la = $("lock-alert");
        if (la) {
          la.style.opacity = "1";
          la.style.transform = "scale(1)";
        }
        const mi = $("moon-icon");
        if (mi)
          mi.className =
            "ph-fill ph-crosshair text-3xl text-purple-500 drop-shadow-[0_0_15px_#d946ef]";
        const tv = $("target-val");
        if (tv) tv.classList.replace("text-gray-400", "text-purple-500");
        const ap = $("azimuth-pill");
        if (ap)
          ap.className =
            "mt-1 bg-purple-500 text-white px-1.5 rounded text-[8px] font-mono font-bold shadow-glow-accent";
      }

      function disengageLock() {
        if (!sys.isLocked) return;
        sys.isLocked = false;
        const cu = $("compass-unit");
        if (cu) cu.classList.remove("locked");
        const la = $("lock-alert");
        if (la) {
          la.style.opacity = "0";
          la.style.transform = "scale(0.75)";
        }
        const mi = $("moon-icon");
        if (mi)
          mi.className =
            "ph-fill ph-moon-stars text-3xl text-gray-400 drop-shadow-md";
        const tv = $("target-val");
        if (tv) tv.classList.replace("text-purple-500", "text-gray-400");
        const ap = $("azimuth-pill");
        if (ap)
          ap.className =
            "mt-1 bg-black/60 border border-white/10 px-1.5 rounded text-[8px] font-mono text-gray-400";
      }

      function updateTelemetry() {
        if (!sys.lat) return;
        const now = new Date();
        const times = SunCalc.getMoonTimes(now, sys.lat, sys.lon);
        const mp = SunCalc.getMoonPosition(now, sys.lat, sys.lon);
        const mi = SunCalc.getMoonIllumination(now);

        // Correct Azimuth/Altitude
        // SunCalc returns radians. Azimuth is 0=South, increasing westward? No, check docs.
        // SunCalc: azimuth: 0 is South and Math.PI * 3/4 is Northwest.
        // Standard Compass: 0 is North, 90 East.
        // Formula: (azimuth * 180/PI) + 180.
        // If SunCalc returns 0 (South), +180 = 180 (South). Correct.
        sys.moonAz = (mp.azimuth * (180 / Math.PI) + 180) % 360;
        sys.moonAlt = mp.altitude * (180 / Math.PI);
        sys.moonDist = mp.distance;

        // Cardinal direction text
        const moonDir = getCardinal(sys.moonAz);
        // Format degrees properly
        const degTxt = `${Math.round(sys.moonAz)}° ${moonDir}`;
        safeText("target-val", degTxt);
        safeText("azimuth-pill", degTxt);
        safeText("az-grid-val", degTxt);

        safeText("alt-val", `ALT: ${Math.round(sys.moonAlt)}°`);
        safeText("phase-val", Math.round(mi.fraction * 100) + "%"); // Fraction is illuminated area
        safeText("illum-val", Math.round(mi.fraction * 100) + "%");
        safeText("dist-val", (sys.moonDist / 1000).toFixed(1) + "K");
        safeText("cloud-val", sys.clouds + "%");
        safeText("humid-val", sys.humidity + "%");

        const fmt = (d) =>
          d
            ? d.toLocaleTimeString("es-ES", {
                hour: "2-digit",
                minute: "2-digit",
              })
            : "--:--";

        // Rise/Set logic can be tricky if the event happened "yesterday" relative to today
        // But SunCalc returns events for the given date.
        // If rise is undefined, it might not rise today.
        safeText("rise-val", fmt(times.rise));
        safeText("set-val", fmt(times.set));

        // Determine Peak (highest altitude)
        // We just iterate to find max.
        let peakAlt = -90;
        let peakTime = null;
        const startDay = new Date(now);
        startDay.setHours(0, 0, 0, 0);
        // Use 15m intervals for better precision
        for (let i = 0; i <= 24 * 4; i++) {
          const t = new Date(startDay.getTime() + i * 15 * 60000);
          const p = SunCalc.getMoonPosition(t, sys.lat, sys.lon);
          if (p.altitude > peakAlt) {
            peakAlt = p.altitude;
            peakTime = t;
          }
        }
        safeText("peak-val", peakTime ? fmt(peakTime) : "N/A");

        const bar = $("status-bar");
        const title = $("vis-verdict");
        const icon = $("vis-icon");
        if (bar && title && icon) {
          if (sys.moonAlt < 0) {
            bar.className =
              "hud-module p-3 flex items-center justify-between border-l-4 border-danger transition-colors duration-500";
            title.innerText = "NO VISIBLE";
            title.className =
              "text-xl font-sans font-bold text-danger leading-none mt-1";
            icon.className = "ph-fill ph-eye-closed text-xl text-danger";
          } else if (sys.clouds > 70) {
            bar.className =
              "hud-module p-3 flex items-center justify-between border-l-4 border-warning transition-colors duration-500";
            title.innerText = "OBSTRUIDO";
            title.className =
              "text-xl font-sans font-bold text-warning leading-none mt-1";
            icon.className = "ph-fill ph-cloud text-xl text-warning";
          } else {
            bar.className =
              "hud-module p-3 flex items-center justify-between border-l-4 border-success transition-colors duration-500";
            title.innerText = "ÓPTIMO";
            title.className =
              "text-xl font-sans font-bold text-success leading-none mt-1 shadow-glow-primary";
            icon.className =
              "ph-fill ph-eye text-xl text-success animate-pulse";
          }
        }

        // Also redraw graph occasionally to keep "NOW" dot updated
        drawConeGraph(now);
      }

      function drawConeGraph(now) {
        const cvs = $("graph-canvas");
        if (!cvs) return;
        const ctx = cvs.getContext("2d");
        // Scale by pixel ratio for sharpness if desired, but kept simple here
        const w = cvs.parentElement.offsetWidth;
        const h = cvs.parentElement.offsetHeight;
        cvs.width = w;
        cvs.height = h;

        const start = new Date(now);
        start.setHours(0, 0, 0, 0);

        ctx.clearRect(0, 0, w, h);

        // Horizon Line
        const horizonY = h * 0.85;
        ctx.beginPath();
        ctx.strokeStyle = "rgba(255,255,255,0.2)";
        ctx.lineWidth = 1;
        ctx.setLineDash([3, 3]);
        ctx.moveTo(0, horizonY);
        ctx.lineTo(w, horizonY);
        ctx.stroke();
        ctx.setLineDash([]);

        // Plot Trajectory (0 to 24h)
        ctx.beginPath();
        let first = true;

        // Gradient fill setup
        const grad = ctx.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, "rgba(56, 189, 248, 0.4)");
        grad.addColorStop(1, "rgba(0, 0, 0, 0)");

        let points = [];

        for (let i = 0; i <= 24; i += 0.5) {
          // 30 min steps
          const t = new Date(start.getTime() + i * 3600000);
          const pos = SunCalc.getMoonPosition(t, sys.lat, sys.lon);
          // Map Altitude (-90 to 90) to Y
          // 90deg (Zenith) -> slightly below top
          // 0deg (Horizon) -> horizonY
          // -90deg -> below

          // Scale factor: 90 degrees = horizonY - some_padding
          const pxPerDeg = (horizonY - 20) / 90;
          const y = horizonY - pos.altitude * (180 / Math.PI) * pxPerDeg;
          const x = (i / 24) * w;

          points.push({ x, y });
          if (first) {
            ctx.moveTo(x, y);
            first = false;
          } else {
            ctx.lineTo(x, y);
          }
        }

        // Close path for fill
        ctx.lineTo(w, h);
        ctx.lineTo(0, h);
        ctx.closePath();
        ctx.fillStyle = grad;
        ctx.fill();

        // Stroke the line
        ctx.beginPath();
        first = true;
        for (let p of points) {
          if (first) {
            ctx.moveTo(p.x, p.y);
            first = false;
          } else {
            ctx.lineTo(p.x, p.y);
          }
        }
        ctx.strokeStyle = "#38bdf8";
        ctx.lineWidth = 2;
        ctx.stroke();

        // Draw "NOW" dot
        const currHours = now.getHours() + now.getMinutes() / 60;
        const currPos = SunCalc.getMoonPosition(now, sys.lat, sys.lon);
        const pxPerDeg = (horizonY - 20) / 90;
        const nowY = horizonY - currPos.altitude * (180 / Math.PI) * pxPerDeg;
        const nowX = (currHours / 24) * w;

        // Only draw if within bounds (roughly)
        if (nowX >= 0 && nowX <= w) {
          const isVisible = currPos.altitude > 0;

          ctx.beginPath();
          ctx.strokeStyle = "rgba(255,255,255,0.5)";
          ctx.lineWidth = 1;
          ctx.moveTo(nowX, nowY);
          ctx.lineTo(nowX, horizonY);
          ctx.stroke();

          ctx.beginPath();
          ctx.arc(nowX, nowY, 6, 0, Math.PI * 2);
          ctx.fillStyle = isVisible ? "#ffffff" : "#64748b";
          ctx.fill();

          ctx.fillStyle = isVisible ? "#38bdf8" : "#64748b";
          ctx.font = "bold 10px Orbitron";
          ctx.textAlign = "center";
          ctx.fillText("AHORA", nowX, nowY - 10);
        }
      }

      const futBtn = $("future-btn");
      if (futBtn)
        futBtn.addEventListener("click", () => {
          const p = $("future-panel");
          if (p) p.classList.toggle("hidden");
        });
      const closeFut = $("close-future");
      if (closeFut)
        closeFut.addEventListener("click", () => {
          const p = $("future-panel");
          if (p) p.classList.add("hidden");
        });

      const fCalc = $("f-calc");
      if (fCalc) {
        fCalc.addEventListener("click", async () => {
          const val = $("f-input").value;
          if (!val) return;
          const t = new Date(val);
          const res = $("f-result");
          res.classList.remove("hidden");
          res.innerHTML =
            "<span class='text-primary animate-pulse'>CALCULANDO...</span>";
          const mp = SunCalc.getMoonPosition(t, sys.lat, sys.lon);
          const alt = Math.round(mp.altitude * (180 / Math.PI));
          let c = "--";
          try {
            const iso = val.split("T")[0];
            const r = await fetch(
              `https://api.open-meteo.com/v1/forecast?latitude=${sys.lat}&longitude=${sys.lon}&hourly=cloud_cover&start_date=${iso}&end_date=${iso}&timezone=auto`,
            );
            const d = await r.json();
            c = d.hourly.cloud_cover[t.getHours()] || "--";
          } catch (e) {}
          let status =
            alt > 0 ? (c < 50 ? "VISIBLE" : "RIESGO NUBES") : "NO VISIBLE";
          let color =
            alt > 0
              ? c < 50
                ? "text-success"
                : "text-warning"
              : "text-danger";
          res.innerHTML = `<div class="grid grid-cols-2 gap-2 mt-2 bg-black/40 p-2 rounded"><div><span class="label-tech block">ALT</span><b class="text-white">${alt}°</b></div><div><span class="label-tech block">NUBES</span><b class="text-white">${c}%</b></div></div><div class="${color} font-bold font-mono text-center mt-2 border border-current rounded py-1 text-xs tracking-widest">${status}</div>`;
        });
      }

      // --- VIEW SWITCHING ---
      function switchView(viewId, btn) {
        document.querySelectorAll(".nav-item").forEach((el) => {
          el.classList.remove("active");
          if (
            el.classList.contains("text-gray-500") === false &&
            !el.classList.contains("active")
          ) {
            el.classList.add("text-gray-500");
          }
        });

        if (btn) {
          btn.classList.add("active");
          btn.classList.remove("text-gray-500");
        }

        document
          .querySelectorAll(".view-section")
          .forEach((el) => el.classList.add("hidden"));
        const v = $(viewId);
        if (v) v.classList.remove("hidden");

        if (viewId === "view-ar") startAR();
        else stopAR();
      }

      // AR Mock functions
      function startAR() {
        const v = $("ar-video");
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({ video: { facingMode: "environment" } })
            .then((s) => {
              v.srcObject = s;
              v.play();
            })
            .catch((e) => console.log("AR Error", e));
        }
      }
      function stopAR() {
        const v = $("ar-video");
        if (v.srcObject) v.srcObject.getTracks().forEach((t) => t.stop());
      }

      // Paywall Mocks
      window.openPaywall = () => {
        $("paywall-modal").classList.remove("hidden");
        setTimeout(() => $("paywall-modal").classList.remove("opacity-0"), 10);
      };
      window.closePaywall = () => {
        $("paywall-modal").classList.add("opacity-0");
        setTimeout(() => $("paywall-modal").classList.add("hidden"), 300);
      };
      window.processPayment = () => {
        const b = $("pay-btn");
        b.innerText = "PROCESANDO...";
        setTimeout(() => {
          b.innerText = "¡ÉXITO!";
          setTimeout(closePaywall, 1000);
          sys.isPro = true;
        }, 1500);
      };
    </script>
  </body>
</html>
